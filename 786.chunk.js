"use strict";(self.webpackChunkreact_esri_template=self.webpackChunkreact_esri_template||[]).push([[786,5488],{31343:(e,t,r)=>{r.d(t,{N:()=>u,b:()=>c});var i=r(61514),s=r(62213),n=r(11823),a=r(72023),o=r(93077),h=r(34658),l=r(33834),d=r(51219);function c(e){const t=new d.kG;return t.include(s.w,{linearDepth:!1}),t.include(n.c,e),t.include(o.q,e),t.vertex.uniforms.add("proj","mat4").add("view","mat4"),t.attributes.add("position","vec3"),t.varyings.add("vpos","vec3"),t.vertex.code.add(l.H`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(t.attributes.add("auxpos1","vec3"),t.vertex.uniforms.add("ndcToPixel","vec2"),t.vertex.code.add(l.H`
    vec4 vpos2 = transformPosition(proj, view, auxpos1);
    float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);

    stipplePatternUv = lineSegmentPixelSize * stipplePatternPixelSizeInv;
    ${e.stippleIntegerRepeatsEnabled?"stipplePatternUv = floor(stipplePatternUv + 0.5);":""}

    // Cancel out perspective correct interpolation because we want this length the really represent
    // the screen distance
    stipplePatternUv *= gl_Position.w;
    `)),t.vertex.code.add(l.H`}`),4===e.output&&t.include(a.bA),t.include(i.p2,e),t.fragment.uniforms.add("constantColor","vec4").add("alphaCoverage","float"),t.fragment.code.add(l.H`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.attributeColor?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${l.H.float(h.bf)}) {
      discard;
    }

    ${0===e.output?l.H`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${4===e.output?l.H`outputHighlight();`:""}
  }
  `),t}var u=Object.freeze({__proto__:null,build:c})},54452:(e,t,r)=>{r.d(t,{T:()=>o,b:()=>a});var i=r(84444),s=r(33834),n=r(51219);function a(){const e=new n.kG;return e.include(i.k),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(s.H`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * color;
}`),e}var o=Object.freeze({__proto__:null,build:a})},74332:(e,t,r)=>{r.d(t,{W:()=>_,b:()=>v});var i=r(31777),s=r(61514),n=r(62213),a=r(72023),o=r(4071),h=r(88214),l=r(83917),d=r(71613),c=r(53584),u=r(91123),p=r(34658),f=r(63230),g=r(33834),m=r(51219);function v(e){const t=new m.kG;return t.include(n.w,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(l.n,e),t.include(i.q,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(g.H`
      void main(void) {
        if (waterColor.a < ${g.H.float(p.bf)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${0===e.output?"forwardLinearDepth();":""}
      }
    `)),e.multipassTerrainEnabled&&(t.fragment.include(o.S),t.include(h.l,e)),7===e.output&&(t.include(s.p2,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(g.H`
        void main() {
          discardBySlice(vpos);
          ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),0===e.output&&(t.include(u.M,e),t.include(s.p2,e),e.receiveShadows&&t.include(d.hX,e),t.include(c.B,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(f.Y),t.fragment.code.add(g.H`
      void main() {
        discardBySlice(vpos);
        ${e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - camPos);
        float shadow = ${e.receiveShadows?g.H`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),2===e.output&&(t.include(l.n,e),t.include(u.M,e),t.include(s.p2,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(g.H`
        void main(void) {
          if (waterColor.a < ${g.H.float(p.bf)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(g.H`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(g.H`
        void main(void) {
          if (waterColor.a < ${g.H.float(p.bf)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(g.H`void main() {
gl_FragColor = waterColor;
}`)),4===e.output&&(t.include(a.bA),t.varyings.add("vpos","vec3"),t.vertex.code.add(g.H`
      void main(void) {
        if (waterColor.a < ${g.H.float(p.bf)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(s.p2,e),t.fragment.code.add(g.H`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}var _=Object.freeze({__proto__:null,build:v})},55534:(e,t,r)=>{r.d(t,{a:()=>m,c:()=>v,g:()=>w,h:()=>E,u:()=>y}),r(95830);var i=r(36544),s=r(33655),n=r(91531),a=r(67128),o=r(12811),h=r(17387),l=r(77625),d=r(34720),c=r(37871),u=r(83679),p=r(69899),f=r(2897);const g=i.Z.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");function m(e=L){return{plane:(0,c.Ue)(e.plane),origin:(0,l.a)(e.origin),basis1:(0,l.a)(e.basis1),basis2:(0,l.a)(e.basis2)}}function v(e,t=m()){return _(e.origin,e.basis1,e.basis2,t)}function _(e,t,r,i=m()){return(0,h.g)(i.origin,e),(0,h.g)(i.basis1,t),(0,h.g)(i.basis2,r),y(i),function(e,t){Math.abs((0,h.d)(e.basis1,e.basis2)/((0,h.l)(e.basis1)*(0,h.l)(e.basis2)))>1e-6&&g.warn(t,"Provided basis vectors are not perpendicular"),Math.abs((0,h.d)(e.basis1,P(e)))>1e-6&&g.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-(0,h.d)(P(e),e.origin)-e.plane[3])>1e-6&&g.warn(t,"Plane offset is not consistent with plane origin")}(i,"fromValues()"),i}function y(e){(0,c.my)(e.basis2,e.basis1,e.origin,e.plane)}function x(e,t,r){e!==r&&v(e,r);const i=(0,h.a)(f.WM.get(),P(e),t);return(0,h.b)(r.origin,r.origin,i),r.plane[3]-=t,r}function w(e,t=m()){const r=(e[2]-e[0])/2,i=(e[3]-e[1])/2;return(0,h.s)(t.origin,e[0]+r,e[1]+i,0),(0,h.s)(t.basis1,r,0,0),(0,h.s)(t.basis2,0,i,0),(0,c.al)(0,0,1,0,t.plane),t}function b(e,t,r){return!!(0,c.BR)(e.plane,t,r)&&O(e,r)}function T(e,t,r){const i=z.get();A(e,t,i,z.get());let n=Number.POSITIVE_INFINITY;for(const a of j){const o=H(e,a,F.get()),l=f.WM.get();if((0,c.rx)(i,o,l)){const e=(0,h.r)(f.WM.get(),t.origin,l),i=Math.abs((0,s.ZF)((0,h.d)(t.direction,e)));i<n&&(n=i,(0,h.g)(r,l))}}return n===Number.POSITIVE_INFINITY?S(e,t,r):r}function S(e,t,r){if(b(e,t,r))return r;const i=z.get(),s=z.get();A(e,t,i,s);let n=Number.POSITIVE_INFINITY;for(const a of j){const o=H(e,a,F.get()),l=f.WM.get();if((0,c.dZ)(i,o,l)){const e=(0,u.Jk)(t,l);if(!(0,c.Ac)(s,l))continue;e<n&&(n=e,(0,h.g)(r,l))}}return M(e,t.origin)<n&&C(e,t.origin,r),r}function C(e,t,r){const i=(0,c.nF)(e.plane,t,f.WM.get()),s=(0,d.ct)(I(e,e.basis1),i,-1,1,f.WM.get()),n=(0,d.ct)(I(e,e.basis2),i,-1,1,f.WM.get());return(0,h.f)(r,(0,h.b)(f.WM.get(),s,n),e.origin),r}function R(e,t,r){const{origin:i,basis1:s,basis2:n}=e,a=(0,h.f)(f.WM.get(),t,i),o=(0,p.SR)(s,a),l=(0,p.SR)(n,a),d=(0,p.SR)(P(e),a);return(0,h.s)(r,o,l,d)}function M(e,t){const r=R(e,t,f.WM.get()),{basis1:i,basis2:s}=e,n=(0,h.l)(i),a=(0,h.l)(s),o=Math.max(Math.abs(r[0])-n,0),l=Math.max(Math.abs(r[1])-a,0),d=r[2];return o*o+l*l+d*d}function E(e,t){return Math.sqrt(M(e,t))}function D(e,t){const r=-e.plane[3];return(0,p.SR)(P(e),t)-r}function P(e){return(0,c.mJ)(e.plane)}function O(e,t){const r=(0,h.f)(f.WM.get(),t,e.origin),i=(0,h.p)(e.basis1),s=(0,h.p)(e.basis2),n=(0,h.d)(e.basis1,r),a=(0,h.d)(e.basis2,r);return-n-i<0&&n-i<0&&-a-s<0&&a-s<0}function I(e,t){const r=F.get();return(0,h.g)(r.origin,e.origin),(0,h.g)(r.vector,t),r}function H(e,t,r){const{basis1:i,basis2:s,origin:n}=e,a=(0,h.a)(f.WM.get(),i,t.origin[0]),o=(0,h.a)(f.WM.get(),s,t.origin[1]);(0,h.b)(r.origin,a,o),(0,h.b)(r.origin,r.origin,n);const l=(0,h.a)(f.WM.get(),i,t.direction[0]),d=(0,h.a)(f.WM.get(),s,t.direction[1]);return(0,h.a)(r.vector,(0,h.b)(l,l,d),2),r}function A(e,t,r,i){const s=P(e);(0,c.my)(s,t.direction,t.origin,r),(0,c.my)((0,c.mJ)(r),s,t.origin,i)}const L={plane:(0,c.Ue)(),origin:(0,l.f)(0,0,0),basis1:(0,l.f)(1,0,0),basis2:(0,l.f)(0,1,0)},z=new n.x(c.Ue),F=new n.x(d.Ue),V=(0,l.c)(),N=new n.x((()=>({origin:null,basis1:null,basis2:null,plane:null}))),j=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],U=(0,o.c)(),W=(0,o.c)();Object.freeze({__proto__:null,BoundedPlaneClass:class{constructor(){this.plane=(0,c.Ue)(),this.origin=(0,l.c)(),this.basis1=(0,l.c)(),this.basis2=(0,l.c)()}},create:m,wrap:function(e,t,r){const i=N.get();return i.origin=e,i.basis1=t,i.basis2=r,i.plane=(0,c.re)(0,0,0,0),y(i),i},copy:v,copyWithoutVerify:function(e,t){(0,h.g)(t.origin,e.origin),(0,h.g)(t.basis1,e.basis1),(0,h.g)(t.basis2,e.basis2),(0,c.JG)(e.plane,t.plane)},fromValues:_,updateUnboundedPlane:y,elevate:x,setExtent:function(e,t,r){return w(t,r),x(r,D(e,e.origin),r),r},fromAABoundingRect:w,intersectRay:b,intersectRayClosestSilhouette:function(e,t,r){if(b(e,t,r))return r;const i=T(e,t,f.WM.get());return(0,h.b)(r,t.origin,(0,h.a)(f.WM.get(),t.direction,(0,h.i)(t.origin,i)/(0,h.l)(t.direction))),r},closestPointOnSilhouette:T,closestPoint:S,projectPoint:C,projectPointLocal:R,distance2:M,distance:E,distanceToSilhouette:function(e,t){let r=Number.NEGATIVE_INFINITY;for(const i of j){const s=H(e,i,F.get()),n=(0,d.Jk)(s,t);n>r&&(r=n)}return Math.sqrt(r)},extrusionContainsPoint:function(e,t){return(0,c.Ac)(e.plane,t)&&O(e,t)},axisAt:function(e,t,r,i){return function(e,t,r){switch(t){case 0:(0,h.g)(r,e.basis1),(0,h.n)(r,r);break;case 1:(0,h.g)(r,e.basis2),(0,h.n)(r,r);break;case 2:(0,h.g)(r,P(e))}return r}(e,r,i)},altitudeAt:D,setAltitudeAt:function(e,t,r,i){const s=D(e,t),n=(0,h.a)(V,P(e),r-s);return(0,h.b)(i,t,n),i},equals:function(e,t){return(0,h.k)(e.basis1,t.basis1)&&(0,h.k)(e.basis2,t.basis2)&&(0,h.k)(e.origin,t.origin)},transform:function(e,t,r){return e!==r&&v(e,r),(0,a.a)(U,t),(0,a.e)(U,U),(0,h.m)(r.basis1,e.basis1,U),(0,h.m)(r.basis2,e.basis2,U),(0,h.m)((0,c.mJ)(r.plane),(0,c.mJ)(e.plane),U),(0,h.m)(r.origin,e.origin,t),(0,c.T5)(r.plane,r.origin,r.plane),r},rotate:function(e,t,r,i){return e!==i&&v(e,i),(0,a.c)(W,(0,a.i)(W),t,r),(0,h.m)(i.basis1,e.basis1,W),(0,h.m)(i.basis2,e.basis2,W),y(i),i},normal:P,UP:L})},78048:(e,t,r)=>{r.d(t,{e:()=>a});var i,s,n={exports:{}};i=n,void 0!==(s=function(){function e(e,r,s){s=s||2;var n,a,o,l,d,c,u,p=r&&r.length,f=p?r[0]*s:e.length,g=t(e,0,f,s,!0),m=[];if(!g||g.next===g.prev)return m;if(p&&(g=h(e,r,g,s)),e.length>80*s){n=o=e[0],a=l=e[1];for(var v=s;v<f;v+=s)(d=e[v])<n&&(n=d),(c=e[v+1])<a&&(a=c),d>o&&(o=d),c>l&&(l=c);u=0!==(u=Math.max(o-n,l-a))?1/u:0}return i(g,m,s,n,a,u),m}function t(e,t,r,i,s){var n,a;if(s===M(e,t,r,i)>0)for(n=t;n<r;n+=i)a=S(n,e[n],e[n+1],a);else for(n=r-i;n>=t;n-=i)a=S(n,e[n],e[n+1],a);return a&&_(a,a.next)&&(C(a),a=a.next),a}function r(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!_(i,i.next)&&0!==v(i.prev,i,i.next))i=i.next;else{if(C(i),(i=t=i.prev)===i.next)break;r=!0}}while(r||i!==t);return t}function i(e,t,h,l,d,c,p){if(e){!p&&c&&u(e,l,d,c);for(var f,g,m=e;e.prev!==e.next;)if(f=e.prev,g=e.next,c?n(e,l,d,c):s(e))t.push(f.i/h),t.push(e.i/h),t.push(g.i/h),C(e),e=g.next,m=g.next;else if((e=g)===m){p?1===p?i(e=a(r(e),t,h),t,h,l,d,c,2):2===p&&o(e,t,h,l,d,c):i(r(e),t,h,l,d,c,1);break}}}function s(e){var t=e.prev,r=e,i=e.next;if(v(t,r,i)>=0)return!1;for(var s=e.next.next;s!==e.prev;){if(g(t.x,t.y,r.x,r.y,i.x,i.y,s.x,s.y)&&v(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function n(e,t,r,i){var s=e.prev,n=e,a=e.next;if(v(s,n,a)>=0)return!1;for(var o=s.x<n.x?s.x<a.x?s.x:a.x:n.x<a.x?n.x:a.x,h=s.y<n.y?s.y<a.y?s.y:a.y:n.y<a.y?n.y:a.y,l=s.x>n.x?s.x>a.x?s.x:a.x:n.x>a.x?n.x:a.x,d=s.y>n.y?s.y>a.y?s.y:a.y:n.y>a.y?n.y:a.y,c=p(o,h,t,r,i),u=p(l,d,t,r,i),f=e.prevZ,m=e.nextZ;f&&f.z>=c&&m&&m.z<=u;){if(f!==e.prev&&f!==e.next&&g(s.x,s.y,n.x,n.y,a.x,a.y,f.x,f.y)&&v(f.prev,f,f.next)>=0)return!1;if(f=f.prevZ,m!==e.prev&&m!==e.next&&g(s.x,s.y,n.x,n.y,a.x,a.y,m.x,m.y)&&v(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;f&&f.z>=c;){if(f!==e.prev&&f!==e.next&&g(s.x,s.y,n.x,n.y,a.x,a.y,f.x,f.y)&&v(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;m&&m.z<=u;){if(m!==e.prev&&m!==e.next&&g(s.x,s.y,n.x,n.y,a.x,a.y,m.x,m.y)&&v(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function a(e,t,i){var s=e;do{var n=s.prev,a=s.next.next;!_(n,a)&&y(n,s,s.next,a)&&b(n,a)&&b(a,n)&&(t.push(n.i/i),t.push(s.i/i),t.push(a.i/i),C(s),C(s.next),s=e=a),s=s.next}while(s!==e);return r(s)}function o(e,t,s,n,a,o){var h=e;do{for(var l=h.next.next;l!==h.prev;){if(h.i!==l.i&&m(h,l)){var d=T(h,l);return h=r(h,h.next),d=r(d,d.next),i(h,t,s,n,a,o),void i(d,t,s,n,a,o)}l=l.next}h=h.next}while(h!==e)}function h(e,i,s,n){var a,o,h,c=[];for(a=0,o=i.length;a<o;a++)(h=t(e,i[a]*n,a<o-1?i[a+1]*n:e.length,n,!1))===h.next&&(h.steiner=!0),c.push(f(h));for(c.sort(l),a=0;a<c.length;a++)s=r(s=d(c[a],s),s.next);return s}function l(e,t){return e.x-t.x}function d(e,t){var i=function(e,t){var r,i=t,s=e.x,n=e.y,a=-1/0;do{if(n<=i.y&&n>=i.next.y&&i.next.y!==i.y){var o=i.x+(n-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=s&&o>a){if(a=o,o===s){if(n===i.y)return i;if(n===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(s===a)return r;var h,l=r,d=r.x,u=r.y,p=1/0;i=r;do{s>=i.x&&i.x>=d&&s!==i.x&&g(n<u?s:a,n,d,u,n<u?a:s,n,i.x,i.y)&&(h=Math.abs(n-i.y)/(s-i.x),b(i,e)&&(h<p||h===p&&(i.x>r.x||i.x===r.x&&c(r,i)))&&(r=i,p=h)),i=i.next}while(i!==l);return r}(e,t);if(!i)return t;var s=T(i,e),n=r(i,i.next);return r(s,s.next),t===i?n:t}function c(e,t){return v(e.prev,e,t.prev)<0&&v(t.next,e,e.next)<0}function u(e,t,r,i){var s=e;do{if(null===s.z&&(s.z=p(s.x,s.y,t,r,i)),s.prev.next!==s||s.next.prev!==s)return s.prev.next=s,s.next.prev=s,u(e,t,r,i);s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==e);s.prevZ.nextZ=null,s.prevZ=null,function(e){var t,r,i,s,n,a,o,h,l=1;do{for(r=e,e=null,n=null,a=0;r;){for(a++,i=r,o=0,t=0;t<l&&(o++,i=i.nextZ);t++);for(h=l;o>0||h>0&&i;)0!==o&&(0===h||!i||r.z<=i.z)?(s=r,r=r.nextZ,o--):(s=i,i=i.nextZ,h--),n?n.nextZ=s:e=s,s.prevZ=n,n=s;r=i}n.nextZ=null,l*=2}while(a>1)}(s)}function p(e,t,r,i,s){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*s)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function f(e){var t=e,r=e;do{(t.x<r.x||t.x===r.x&&t.y<r.y)&&(r=t),t=t.next}while(t!==e);return r}function g(e,t,r,i,s,n,a,o){return(s-a)*(t-o)-(e-a)*(n-o)>=0&&(e-a)*(i-o)-(r-a)*(t-o)>=0&&(r-a)*(n-o)-(s-a)*(i-o)>=0}function m(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&y(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&(b(e,t)&&b(t,e)&&function(e,t){var r=e,i=!1,s=(e.x+t.x)/2,n=(e.y+t.y)/2;do{r.y>n!=r.next.y>n&&r.next.y!==r.y&&s<(r.next.x-r.x)*(n-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}(e,t)&&(v(e.prev,e,t.prev)||v(e,t.prev,t))||_(e,t)&&v(e.prev,e,e.next)>0&&v(t.prev,t,t.next)>0)}function v(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function _(e,t){return e.x===t.x&&e.y===t.y}function y(e,t,r,i){var s=w(v(e,t,r)),n=w(v(e,t,i)),a=w(v(r,i,e)),o=w(v(r,i,t));return s!==n&&a!==o||!(0!==s||!x(e,r,t))||!(0!==n||!x(e,i,t))||!(0!==a||!x(r,e,i))||!(0!==o||!x(r,t,i))}function x(e,t,r){return t.x<=Math.max(e.x,r.x)&&t.x>=Math.min(e.x,r.x)&&t.y<=Math.max(e.y,r.y)&&t.y>=Math.min(e.y,r.y)}function w(e){return e>0?1:e<0?-1:0}function b(e,t){return v(e.prev,e,e.next)<0?v(e,t,e.next)>=0&&v(e,e.prev,t)>=0:v(e,t,e.prev)<0||v(e,e.next,t)<0}function T(e,t){var r=new R(e.i,e.x,e.y),i=new R(t.i,t.x,t.y),s=e.next,n=t.prev;return e.next=t,t.prev=e,r.next=s,s.prev=r,i.next=r,r.prev=i,n.next=i,i.prev=n,i}function S(e,t,r,i){var s=new R(e,t,r);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function C(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function R(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function M(e,t,r,i){for(var s=0,n=t,a=r-i;n<r;n+=i)s+=(e[a]-e[n])*(e[n+1]+e[a+1]),a=n;return s}return e.deviation=function(e,t,r,i){var s=t&&t.length,n=s?t[0]*r:e.length,a=Math.abs(M(e,0,n,r));if(s)for(var o=0,h=t.length;o<h;o++){var l=t[o]*r,d=o<h-1?t[o+1]*r:e.length;a-=Math.abs(M(e,l,d,r))}var c=0;for(o=0;o<i.length;o+=3){var u=i[o]*r,p=i[o+1]*r,f=i[o+2]*r;c+=Math.abs((e[u]-e[f])*(e[p+1]-e[u+1])-(e[u]-e[p])*(e[f+1]-e[u+1]))}return 0===a&&0===c?0:Math.abs((c-a)/a)},e.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},i=0,s=0;s<e.length;s++){for(var n=0;n<e[s].length;n++)for(var a=0;a<t;a++)r.vertices.push(e[s][n][a]);s>0&&(i+=e[s-1].length,r.holes.push(i))}return r},e}())&&(i.exports=s);var a=n.exports},82204:(e,t,r)=>{r.d(t,{d:()=>s});var i=r(33655);function s(e,t,r){var s;const l=e.byteLength/(4*t),d=new Uint32Array(e,0,l*t);let c=new Uint32Array(l);const u=null!=(s=null==r?void 0:r.minReduction)?s:0,p=(null==r?void 0:r.originalIndices)||null,f=p?p.length:0,g=(null==r?void 0:r.componentOffsets)||null;let m=0;if(g)for(let e=0;e<g.length-1;e++){const t=g[e+1]-g[e];t>m&&(m=t)}else m=l;const v=Math.floor(1.1*m)+1;(null==h||h.length<2*v)&&(h=new Uint32Array((0,i.Sf)(2*v)));for(let e=0;e<2*v;e++)h[e]=0;let _=0;const y=!!g&&!!p,x=y?f:l,w=y?new Uint32Array(f):null,b=1.96;let T=0!==u?Math.ceil(4*b*b/(u*u)*u*(1-u)):x,S=1,C=g?g[1]:x;for(let e=0;e<x;e++){if(e===T){const t=1-_/e;if(t+b*Math.sqrt(t*(1-t)/e)<u)return null;T*=2}if(e===C){for(let e=0;e<2*v;e++)h[e]=0;if(p)for(let e=g[S-1];e<g[S];e++)w[e]=c[p[e]];C=g[++S]}const r=y?p[e]:e,i=r*t,s=o(d,i,t);let a=s%v,l=_;for(;0!==h[2*a+1];){if(h[2*a]===s){const e=h[2*a+1]-1;if(n(d,i,e*t,t)){l=c[e];break}}a++,a>=v&&(a-=v)}l===_&&(h[2*a]=s,h[2*a+1]=r+1,_++),c[r]=l}if(0!==u&&1-_/l<u)return null;if(y){for(let e=g[S-1];e<w.length;e++)w[e]=c[p[e]];c=w}const R=new Uint32Array(t*_);_=0;for(let e=0;e<x;e++)c[e]===_&&(a(d,(y?p[e]:e)*t,R,_*t,t),_++);if(p&&!y){const e=new Uint32Array(f);for(let t=0;t<e.length;t++)e[t]=c[p[t]];c=e}return{buffer:R.buffer,indices:c,uniqueCount:_}}function n(e,t,r,i){for(let s=0;s<i;s++)if(e[t+s]!==e[r+s])return!1;return!0}function a(e,t,r,i,s){for(let n=0;n<s;n++)r[i+n]=e[t+n]}function o(e,t,r){let i=0;for(let s=0;s<r;s++)i=e[t+s]+i|0,i=i+(i<<11)+(i>>>2)|0;return i>>>0}let h=null},99776:(e,t,r)=>{r.d(t,{M:()=>o,b:()=>a});var i=r(78048),s=r(92232),n=r(82204);function a(e){const t=o(e.rings,e.hasZ,1),r=[];let s=0,a=0;for(const e of t.polygons){const n=e.count,o=e.index,h=new Float64Array(t.position.buffer,3*o*t.position.BYTES_PER_ELEMENT,3*n),l=e.holeIndices.map((e=>e-o)),d=new Uint32Array((0,i.e)(h,l,3));r.push({position:h,faces:d}),s+=h.length,a+=d.length}const h=function(e,t,r){if(1===e.length)return e[0];const i=new Float64Array(t),s=new Uint32Array(r);let n=0,a=0,o=0;for(const t of e){for(let e=0;e<t.position.length;e++)i[n++]=t.position[e];for(let e=0;e<t.faces.length;e++)s[a++]=t.faces[e]+o;o=n/3}return{position:i,faces:s}}(r,s,a),l=(0,n.d)(h.position.buffer,6,{originalIndices:h.faces});return h.position=new Float64Array(l.buffer),h.faces=l.indices,h}function o(e,t,r){const i=e.length,s=new Array(i),n=new Array(i),a=new Array(i);let o=0,d=0,c=0,u=0;for(let t=0;t<i;++t)u+=e[t].length;const p=new Float64Array(3*u);let f=0;for(let u=i-1;u>=0;u--){const g=e[u],m=1===r&&l(g);if(m&&1!==i)s[o++]=g;else{let e=g.length;for(let t=0;t<o;++t)e+=s[t].length;const r={index:f,pathLengths:new Array(o+1),count:e,holeIndices:new Array(o)};r.pathLengths[0]=g.length,g.length>0&&(a[c++]={index:f,count:g.length}),f=m?h(g,g.length-1,-1,p,f,g.length,t):h(g,0,1,p,f,g.length,t);for(let e=0;e<o;++e){const i=s[e];r.holeIndices[e]=f,r.pathLengths[e+1]=i.length,i.length>0&&(a[c++]={index:f,count:i.length}),f=h(i,0,1,p,f,i.length,t)}o=0,r.count>0&&(n[d++]=r)}}for(let e=0;e<o;++e){const r=s[e];r.length>0&&(a[c++]={index:f,count:r.length}),f=h(r,0,1,p,f,r.length,t)}return d<i&&(n.length=d),c<i&&(a.length=c),{position:p,polygons:n,outlines:a}}function h(e,t,r,i,s,n,a){s*=3;for(let o=0;o<n;++o){const n=e[t];i[s++]=n[0],i[s++]=n[1],i[s++]=a?n[2]:0,t+=r}return s/3}function l(e){return!(0,s.bu)(e,!1,!1)}},93293:(e,t,r)=>{r.d(t,{ZF:()=>s,rD:()=>n,a1:()=>a});var i=r(38256);const s=1.2,n=i.Z,a=i.O},78641:(e,t,r)=>{r.d(t,{YU:()=>f,VP:()=>g,rm:()=>v});var i=r(33655),s=r(59472),n=r(6962),a=r(17387),o=r(77625),h=r(28449),l=r(99776),d=r(93293),c=r(81718),u=r(2245),p=r(68500);function f(e){const t=[],r=[];!function(e,t,r){const{attributeData:{position:i},removeDuplicateStartEnd:s}=e,a=function(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&1===s,o=i.length/3-(a?1:0),h=new Uint32Array(2*(o-1)),l=a?(0,n.tP)(i,0,i.length-3):i;let d=0;for(let e=0;e<o-1;e++)h[d++]=e,h[d++]=e+1;t.push(["position",{size:3,data:l,exclusive:a}]),r.push(["position",h])}(e,r,t);const o=r[0][1].data,h=t[0][1].length,l=new Uint16Array(h);return function(e,t,r){const i=e.attributeData.mapPosition;(0,s.Wi)(i)||(r.push(["mapPos",r[0][1]]),t.push(["mapPos",{size:3,data:i}]))}(e,r,t),function(e,t,r,i){if((0,s.pC)(e.attributeData.colorFeature))return;const n=e.attributeData.color;t.push(["color",{size:4,data:(0,s.Pt)(n,d.a1)}]),r.push(["color",i])}(e,r,t,l),function(e,t,r,i){if((0,s.pC)(e.attributeData.sizeFeature))return;const n=e.attributeData.size;t.push(["size",{size:1,data:[(0,s.Pt)(n,1)]}]),r.push(["size",i])}(e,r,t,l),function(e,t,r,i){const n=e.attributeData.colorFeature;(0,s.Wi)(n)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([n])}]),r.push(["color",i]))}(e,r,t,l),function(e,t,r,i){const n=e.attributeData.sizeFeature;(0,s.Wi)(n)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([n])}]),r.push(["sizeFeatureAttribute",i]))}(e,r,t,l),function(e,t,r,i){const n=e.attributeData.opacityFeature;(0,s.Wi)(n)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([n])}]),r.push(["opacityFeatureAttribute",i]))}(e,r,t,l),function(e,t,r,n){if("round"!==e.join)return;const o=n.length/3,h=new Float32Array(o),l=y,d=x;(0,a.s)(l,0,0,0);const c=(0,s.Pt)(e.uniformSize,1);for(let e=-1;e<o;++e){const t=e<0?o+e:e,r=(e+1)%o;if((0,a.s)(d,n[3*r+0]-n[3*t+0],n[3*r+1]-n[3*t+1],n[3*r+2]-n[3*t+2]),(0,a.n)(d,d),e>=0){const t=(Math.PI-(0,i.ZF)((0,a.d)(l,d)))*w*1*_(c);h[e]=Math.max(Math.floor(t),0)}(0,a.a)(l,d,-1)}t.push(["subdivisions",{size:1,data:h}]),r.push(["subdivisions",r[0][1]])}(e,r,t,o),new p.Z(r,t,2)}function g(e,t,r,i){const s="polygon"===e.type?1:0,n="polygon"===e.type?e.rings:e.paths,{position:a,outlines:o}=(0,l.M)(n,e.hasZ,s),h=new Float64Array(a.length),d=(0,c.rR)(a,e.spatialReference,0,h,0,a,0,a.length/3,t,r,i),u=null!=d;return{lines:u?m(o,a,h):[],projectionSuccess:u,sampledElevation:d}}function m(e,t,r){const i=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const e=3*s,a=e+3*n;i.push({position:t.subarray(e,a),mapPosition:r?r.subarray(e,a):void 0})}return i}function v(e,t){const r="polygon"===e.type?1:0,i="polygon"===e.type?e.rings:e.paths,{position:s,outlines:n}=(0,l.M)(i,!1,r),a=(0,h.CM)(s,e.spatialReference,0,s,t,0,s.length/3);for(let e=2;e<s.length;e+=3)s[e]=u.Rn;return{lines:a?m(n,s):[],projectionSuccess:a}}function _(e){return 1.863798+-2.0062872/(1+e/18.2313)**.8856294}const y=(0,o.c)(),x=(0,o.c)(),w=4/Math.PI},42898:(e,t,r)=>{r.d(t,{km:()=>f,dO:()=>g,VP:()=>v,S_:()=>m});var i=r(59472),s=r(12811),n=r(77625),a=r(28449),o=r(69996),h=r(92232),l=r(45201),d=r(81718),c=r(74218),u=r(88909);const p=(0,n.c)();function f(e,t,r,n,h,l,c,f,g,m){const v=r?r.length:0,_=e.clippingExtent;if((0,a.KC)(t,p,e.elevationProvider.spatialReference),(0,i.pC)(_)&&!(0,o.BD)(_,p))return null;const y=e.renderCoordsHelper.spatialReference;(0,a.KC)(t,p,y);const x=e.localOriginFactory.getOrigin(p),w=new u.T({castShadow:!1,metadata:{layerUid:f,graphicUid:g,usesVerticalDistanceToGround:!0}});for(let e=0;e<v;e++){const t=h?h[e]:s.I;w.addGeometry(r[e],n[e],t,l,x,m)}return{object:w,sampledElevation:(0,d.bD)(w,t,e.elevationProvider,e.renderCoordsHelper,c)}}function g(e,t,r){const i=e.elevationContext,s=r.spatialReference;(0,a.KC)(t,p,s),i.centerPointInElevationSR=(0,l.Tx)(p[0],p[1],t.hasZ?p[2]:0,s)}function m(e){switch(e.type){case"point":return e;case"polygon":case"extent":return(0,c.zE)(e);case"polyline":{const t=e.paths[0];if(!t||0===t.length)return null;const r=(0,h.n8)(t,(0,h.ok)(t)/2);return(0,l.Tx)(r[0],r[1],r[2],e.spatialReference)}case"mesh":return e.origin}return null}function v(e,t,r,i,s){const n=new Float64Array(3*e.length),a=new Float64Array(n.length);e.forEach(((e,t)=>{n[3*t+0]=e[0],n[3*t+1]=e[1],n[3*t+2]=e.length>2?e[2]:0}));const o=(0,d.rR)(n,t,0,a,0,n,0,n.length/3,r,i,s),h=null!=o;return{numVertices:e.length,position:n,mapPosition:a,projectionSuccess:h,sampledElevation:o}}},25026:(e,t,r)=>{r.d(t,{Z:()=>h});var i=r(56140),s=r(82677),n=r(79881),a=(r(95830),r(68055),r(36544),r(87566));let o=class extends s.Z{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.SCENEVIEW_LOCKING_LOG=!1,this.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,this.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,this.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,this.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.ENABLE_PROFILE_DEPTH_RANGE=!1,this.DISABLE_FAST_UPDATES=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1}};(0,i._)([(0,n.Cb)()],o.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"SCENEVIEW_LOCKING_LOG",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"DECONFLICTOR_SHOW_GRID",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"LABELS_SHOW_BORDER",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"OVERLAY_SHOW_CENTER",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"SHOW_POI",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"I3S_TREE_SHOW_TILES",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"I3S_SHOW_MODIFICATIONS",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"DISABLE_FAST_UPDATES",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),(0,i._)([(0,n.Cb)()],o.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),o=(0,i._)([(0,a.j)("esri.views.3d.support.DebugFlags")],o);const h=new o},2245:(e,t,r)=>{r.d(t,{Rn:()=>Xe});var i=r(56140),s=r(82677),n=r(59691),a=r(36544),o=r(77293),h=r(59472),l=r(62698),d=r(79261),c=r(80621),u=r(79881),p=(r(95830),r(68055),r(87566)),f=r(67128),g=r(55735),m=r(77625),v=r(25026),_=r(33655),y=r(34353),x=r(50897),w=r(60245);class b{constructor(e,t){this.index=e,this.renderTargets=t,this.extent=(0,x.Ue)(),this.resolution=0,this.viewport=(0,x.Ue)(),this.renderLocalOrigin=(0,w.al)(0,0,0,"O"),this.pixelRatio=1,this.canvasGeometries={extents:[(0,x.Ue)(),(0,x.Ue)(),(0,x.Ue)()],numViews:0},this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(t.renderTargets.length).fill(!1)}getValidTarget(e){return this.validTargets[e]?this.renderTargets.getTarget(e):null}get needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const t=1===e?this.renderTargets.getTarget(0):2===e?this.renderTargets.getTarget(2):this.renderTargets.getTarget(4);return t?t.getTexture():null}getNormalTexture(e){const t=1===e?this.renderTargets.getTarget(3):null;return t?t.getTexture():null}draw(e,t){const r=this.computeRenderTargetValidityBitfield(),i=this.needsColorWithoutRasterImage;for(const r of this.renderTargets.renderTargets)1===r.type&&!1===i?this.validTargets[r.type]=!1:this.validTargets[r.type]=e.drawTarget(this,r,t);return r^this.computeRenderTargetValidityBitfield()?0:1}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[0]|+e[1]<<1|+e[2]<<2|+e[3]<<3|+e[4]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const t=.001*e.range;if(this.extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,x.cv)(this.extent,e.range,0,t)}if(this.extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,x.cv)(this.extent,-e.range,0,t)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,(0,x.t8)(this.canvasGeometries.extents[0],this.extent),(0,y.s)(this.viewport,0,0,this.resolution,this.resolution)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}applyViewport(e){const t=this.viewport;0===this.index?e.setViewport(t[0],t[1],t[2],t[3]):e.setViewport(t[0]+this.resolution,t[1],t[2],t[3])}}var T=r(27851),S=r(91494),C=r(84570),R=(r(86920),r(88378),r(5627),r(8634)),M=r(74038);class E{constructor(e,t){this.size=(0,T.c)(),this._fbo=null,this._fbo=new C.Z(e,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:t,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=(0,h.O3)(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return null!==this._fbo}resize(e,t){this.size[0]=e,this.size[1]=t,this._fbo.resize(this.size[0],this.size[1])}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var e;null==(e=this._fbo)||e.resize(0,0)}get gpuMemoryUsage(){var e,t;return null!=(e=null==(t=this._fbo)?void 0:t.gpuMemoryUsage)?e:0}}class D{constructor(e){this.renderTargets=null;const t=(t,r,i=!0)=>({type:r,fbo:new E(e,i),renderPass:t,valid:!1,lastUsed:1/0});this.renderTargets=[t(0,0),t(0,1),t(5,2,!1),t(3,3),t(0,4)]}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,t,r){if(e)t.lastUsed=r;else if(r-t.lastUsed>P)t.fbo.disposeRenderTargetMemory(),t.lastUsed=1/0;else if(t.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce(((e,t)=>e+t.fbo.gpuMemoryUsage),0)}}const P=1e3;class O{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}}class I{constructor(e){this._context=e,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach((e=>e.forEach((e=>e.technique.dispose())))),this._perConstructorInstances.clear()}acquire(e,t){const r=t.key;let i=this._perConstructorInstances.get(e);i||(i=new Map,this._perConstructorInstances.set(e,i));let s=i.get(r);if(void 0===s){const n=new e(this._context,t,(()=>this.release(n)));s=new O(n),i.set(r,s)}return++s.refCount,s.technique}releaseAndAcquire(e,t,r){if((0,h.pC)(r)){if(t.key===r.key)return r;r.release()}return this.acquire(e,t)}release(e){if((0,h.Wi)(e))return;const t=this._perConstructorInstances.get(e.constructor).get(e.key);--t.refCount,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}frameUpdate(){this._frameCounter++,this._perConstructorInstances.forEach(((e,t)=>{e.forEach(((t,r)=>{0===t.refCount&&t.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(t.technique.dispose(),e.delete(r))})),0===e.size&&this._perConstructorInstances.delete(t)}))}async hotReload(){const e=new Array;this._perConstructorInstances.forEach(((t,r)=>{e.push((async(e,t)=>{const r=t.shader;r&&(await r.reload(),e.forEach((e=>{e.technique.reload(this._context)})))})(t,r))})),await Promise.all(e)}}var H=r(91852),A=r(90168);const L=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function z(e,t){return e+"_"+L.find((e=>e.output===t)).name}var F=r(56469);const V=a.Z.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep");class N{constructor(e){this.refCnt=0,this.glMaterial=e}incRefCnt(){++this.refCnt}decRefCnt(){--this.refCnt,(0,F.hu)(this.refCnt>=0)}getRefCnt(){return this.refCnt}getGLMaterial(){return this.glMaterial}}var j=r(10346),U=r(26899),W=r(81495);class G{constructor(e){this.rctx=e,this.camera=null,this.lastFrameCamera=new A.Z,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=B,this.hasOccludees=!1}resetRenderOccludedMask(){this.renderOccludedMask=B}get isHighlightPass(){return 5===this.pass}}const B=13;class k{constructor(){this.adds=new l.Z,this.removes=new l.Z,this.updates=new l.Z({allocator:e=>e||new Z,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class Z{}class q{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var $=r(10762);function J(e){return e.data.indexCount>=1}var Y=r(12811),K=r(1227);class X{constructor(e){null==e?e=16:e<65536&&(e=(0,_.Sf)(e)),this._array=new Float32Array(e),this._size=0}resize(e,t){if(this._size=e,this._size>this._array.length){let e=this._array.length||1;for(;e<this._size;)e*=2;const r=new Float32Array(e);return t&&r.set(this._array),this._array=r,!0}const r=2*this._size;if(r<=this._array.length){let e=this._array.length;for(;e>=r;)e=Math.floor(e/2);const i=new Float32Array(e);return t&&i.set(this._array.subarray(0,e)),this._array=i,!0}return!1}append(e){const t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}erase(e,t){for(let r=e;r<t;++r)this._array[r]=0}get array(){return this._array}get size(){return this._size}}var Q=r(9816);class ee{constructor(e,t,r,i,s,n){this.from=e,this.to=t,this.isVisible=r,this.hasHighlights=i,this.hasOccludees=s,this.transformation=n,null!=n&&(this.transformationNormal=(0,Y.b)(n),(0,f.a)(this.transformationNormal,this.transformationNormal),(0,f.e)(this.transformationNormal,this.transformationNormal))}}function te(e,t){const r=e=>({first:e.from,count:e.to-e.from});if(0===e.length)return void e.push(r(t));const i=e[e.length-1];if(function(e,t){return e.first+e.count>=t.from}(i,t)){const e=t.from-i.first+t.to-t.from;i.count=e}else e.push(r(t))}var re=r(49366);function ie(e,t,r){(0,h.pC)(r)&&(r.drawCalls+=e,r.triangles+=t)}r(65575);var se=r(57319);function ne(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}const ae={begin:0,end:0},oe=(0,Y.c)(),he=(0,Y.c)(),le=(0,Y.c)();let de=class extends s.Z{constructor(){super(...arguments),this._pending=new ce,this._changes=new k,this._materialRenderers=new Map,this._sortedMaterialRenderers=new l.Z,this._hasHighlights=!1,this._hasWater=!1}dispose(){this._changes.prune(),this._materialRenderers.forEach((e=>e.dispose())),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return(0,o.o)(this._materialRenderers,(e=>e.rendersOccluded))}stopAnimationsAtTime(e){this._sortedMaterialRenderers.forAll((t=>(0,h.yw)(t.material.animation,(t=>t.stopAtTime(e)))))}get isEmpty(){return!this.updating&&0===this._materialRenderers.size}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=function(e){const t=new Map,r=e=>{let r=t.get(e);return r||(r=new q,t.set(e,r)),r};return e.adds.forAll((e=>{J(e)&&r(e.material).adds.push(e)})),e.removes.forAll((e=>{J(e)&&r(e.material).removes.push(e)})),e.updates.forAll((e=>{J(e.renderGeometry)&&r(e.renderGeometry.material).updates.push(e)})),t}(this._changes);let t=!1,r=!1,i=!1;return e.forEach(((e,s)=>{let n=this._materialRenderers.get(s);if(!n&&e.adds.length>0&&(n=new class{constructor(e,t,r){this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=e,this._material=r,this._materialRep=t,this._glMaterials=(0,re.a9)(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}dispose(){(0,re.BX)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((e=>{e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((e=>{e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}get isEmpty(){return 0===this._dataByOrigin.size}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&(0,o.o)(this._glMaterials,(e=>e instanceof Q.w))}get rendersOccluded(){return!this.isEmpty&&1!==this._material.renderOccluded}modify(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}addAndRemoveGeometries(e,t){const r=this._bufferWriter,i=r.vertexBufferLayout,s=i.stride/4,n=this._dataByOrigin,a=function(e,t,r,i){const s=new Map,n=t.vertexBufferLayout.stride/4,a=(r,i)=>{const a=r.origin;if((0,h.Wi)(a))return;const o=e.get(a.id);let l=s.get(a.id);null==l&&(l={optimalCount:null==o?0:o.optimalCount,sparseCount:null==o?0:o.buffer.size,toAdd:[],toRemove:[],origin:a.vec3},s.set(a.id,l));const d=t.elementCount(r.data)*n;i?(l.optimalCount+=d,l.sparseCount+=d,l.toAdd.push(r)):(l.optimalCount-=d,l.toRemove.push(r))};for(const e of r)a(e,!0);for(const e of i)a(e,!1);return s}(n,r,e,t);a.forEach(((e,t)=>{a.delete(t);const r=e.optimalCount,o=e.sparseCount;let h=n.get(t);if(null==h)(0,F.hu)(r>0),h=this.createData(i,r,e.origin),n.set(t,h);else if(0===r)return h.vao.dispose(!0),h.vao=null,void n.delete(t);const l=r<e.sparseCount/2,d=l?r:o,c=ae,u=h.buffer.size,p=h.buffer.array,f=h.buffer.resize(d,!1);l||f?this.removeAndRebuild(h,e.toRemove,s,p,c):e.toRemove.length>0?(this.removeByErasing(h,e.toRemove,s,c),e.toAdd.length>0&&(c.end=u)):(c.begin=u,c.end=u);const g=oe;(0,F.u_)(g,-e.origin[0],-e.origin[1],-e.origin[2]),this.append(h,e.toAdd,s,g,c);const m=h.vao.vertexBuffers.geometry;if(m.byteSize!==h.buffer.array.buffer.byteLength)m.setData(h.buffer.array);else{const{begin:e,end:t}=c;if(e<t){const r=h.buffer.array,i=4,s=e*i,n=t*i;m.setSubData(r,s,s,n)}}h.drawCommandsDirty=!0}))}updateGeometries(e){const t=this._bufferWriter,r=t.vertexBufferLayout.stride/4;for(const i of e){const e=i.updateType,s=i.renderGeometry,n=this._dataByOrigin.get(s.origin.id),a=n&&n.instances.get(s.id);if(!a)return;if(1&e&&(a.isVisible=s.instanceParameters.visible),9&e){const e=s.instanceParameters.visible;a.hasHighlights=!!s.instanceParameters.highlights&&e}if(16&e&&(a.hasOccludees=!!s.instanceParameters.occludees),6&e){const e=n.buffer.array,i=n.vao;(0,re.bZ)(s,he,le),t.write({transformation:he,invTranspTransformation:le},s.data,t.vertexBufferLayout.createView(e.buffer),a.from),(0,F.hu)(a.from+t.elementCount(s.data)===a.to,"material VBO layout has changed"),i.vertexBuffers.geometry.setSubData(e,a.from*r*4,a.from*r*4,a.to*r*4)}n.drawCommandsDirty=!0}}updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((e=>{e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,(0,o.o)(e.instances,(t=>(t.isVisible?(t.hasHighlights&&(this._hasHighlights=!0,e.hasHighlights=!0),t.hasOccludees&&(this._hasOccludees=!0,e.hasOccludees=!0)):e.hasHiddenInstances=!0,e.hasHiddenInstances&&e.hasHighlights&&e.hasOccludees)))})),this._dataByOrigin.forEach((e=>{e.drawCommandsDirty&&((e=>{if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0===e.instances.size)return;if(!ne(e)){const t=4*e.buffer.size/(0,se.m)(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}const t=function(e){return e.sort(((e,t)=>e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0))}([...e.instances.values()]);e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];for(const r of t)r.isVisible&&(r.hasOccludees?te(e.drawCommandsOccludees,r):te(e.drawCommandsDefault,r),r.hasHighlights?te(e.drawCommandsHighlight,r):te(e.drawCommandsShadowHighlightRest,r));const r=e=>{let t=0;for(const r of e)t+=r.count;return t/3};e.stats={default:r(e.drawCommandsDefault),highlight:r(e.drawCommandsHighlight),occludees:r(e.drawCommandsOccludees),shadowHighlightRest:r(e.drawCommandsShadowHighlightRest)}})(e),e.drawCommandsDirty=!1)}))}updateLogic(e){return this._material.update(e)}render(e,t,r,i){const s=this._rctx,n=this._glMaterials.get(t),a=5===t||7===t,o=6===t,l=!(a||o);if(3===t&&null===e&&(e=22),!n||2!==n.ensureResources(s)||null!=e&&!n.beginSlot(e)||a&&!this._hasHighlights)return!1;n.ensureParameters(r);const d=n.getPipelineState(e,!1);s.setPipelineState(d);const c=n.technique;s.useProgram(c.program),n.bind(r);let u=!1;return this._dataByOrigin.forEach((t=>{if((0,h.Wi)(t.drawCommandsDefault)&&(0,h.Wi)(t.drawCommandsHighlight)&&(0,h.Wi)(t.drawCommandsOccludees)&&(0,h.Wi)(t.drawCommandsShadowHighlightRest))return;if(a&&!t.hasHighlights)return;r.origin=t.origin,c.bindDraw(r,{},{}),c.ensureAttributeLocations(t.vao),s.bindVAO(t.vao);const p=c.primitiveType,f=a?t.drawCommandsHighlight:o&&ne(t)?t.drawCommandsShadowHighlightRest:t.drawCommandsDefault;if((0,h.pC)(f)){this.renderCommands(s,p,f);const e=a?t.stats.highlight:o&&ne(t)?t.stats.shadowHighlightRest:t.stats.default;ie(f.length,e,i),u=!0}if(l){const r=t.drawCommandsOccludees;if((0,h.pC)(r)){const a=n.getPipelineState(e,!0);s.setPipelineState(a),this.renderCommands(s,p,r),s.setPipelineState(d),ie(r.length,t.stats.occludees,i),u=!0}}})),u}renderCommands(e,t,r){for(let i=0;i<r.length;i++)e.drawArrays(t,r[i].first,r[i].count)}createData(e,t,r){return{instances:new Map,vao:new M.Z(this._rctx,this._material.vertexAttributeLocations,{geometry:(0,K.K)(e)},{geometry:S.Z.createVertex(this._rctx,35044)}),buffer:new X(t),optimalCount:0,origin:r,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}removeAndRebuild(e,t,r,i,s){for(const i of t){const t=i.id,s=e.instances.get(t);e.optimalCount-=(s.to-s.from)*r,e.instances.delete(t)}let n=0;const a=e.buffer.array;s.begin=0,s.end=0;let o=-1,h=-1,l=0;e.instances.forEach((e=>{const t=e.from*r,s=e.to*r,d=s-t;o!==h&&h!==t?(a.set(i.subarray(o,h),l),l+=h-o,o=t):-1===o&&(o=t),h=s,e.from=n/r,n+=d,e.to=n/r})),o!==h&&a.set(i.subarray(o,h),l),s.end=n}removeByErasing(e,t,r,i){i.begin=1/0,i.end=-1/0;let s=-1,n=-1;for(const a of t){const t=a.id,o=e.instances.get(t),h=o.from*r,l=o.to*r;s!==n&&n!==h?(e.buffer.erase(s,n),s=h):-1===s&&(s=h),n=l,e.instances.delete(t),e.optimalCount-=l-h,h<i.begin&&(i.begin=h),l>i.end&&(i.end=l)}s!==n&&e.buffer.erase(s,n)}append(e,t,r,i,s){const n=this._bufferWriter;for(const a of t){const t=(0,h.pC)(a.transformation)?(0,f.m)(he,i,a.transformation):i;(0,f.a)(le,t),(0,f.e)(le,le);const o=s.end;n.write({transformation:t,invTranspTransformation:le},a.data,n.vertexBufferLayout.createView(e.buffer.array.buffer),s.end/r);const l=n.elementCount(a.data)*r,d=o+l;(0,F.hu)(null==e.instances.get(a.id));const c=a.instanceParameters.visible,u=!!a.instanceParameters.highlights&&c,p=!!a.instanceParameters.occludees,g=new ee(o/r,d/r,c,u,p);e.instances.set(a.id,g),e.optimalCount+=l,s.end+=l}}get test(){return{material:this._material,glMaterials:this._glMaterials}}}(this.rctx,this.materialRepository,s),this._materialRenderers.set(s,n),t=!0,r=!0,i=!0),!n)return;const a=r||n.hasHighlights,l=i||n.hasWater;n.modify(e),r=r||a!==n.hasHighlights,i=i||l!==n.hasWater,n.isEmpty&&(this._materialRenderers.delete(s),n.dispose(),t=!0)})),this._changes.clear(),t&&this.updateSortedMaterialRenderers(),r&&(this._hasHighlights=(0,o.o)(this._materialRenderers,(e=>e.hasHighlights))),i&&(this._hasWater=(0,o.o)(this._materialRenderers,(e=>e.hasWater))),this.notifyChange("updating"),!0}add(e){if(0===e.length)return;const t=this._pending.empty;for(const t of e)this._pending.adds.add(t);t&&this.notifyChange("updating")}remove(e){const t=this._pending.empty;for(const t of e)this._pending.adds.has(t)?(this._pending.removed.add(t),this._pending.adds.delete(t)):this._pending.removed.has(t)||this._pending.removes.add(t);t&&!this._pending.empty&&this.notifyChange("updating")}modify(e,t){const r=0===this._changes.updates.length;for(const r of e){const e=this._changes.updates.pushNew();e.renderGeometry=r,e.updateType=t}r&&this._changes.updates.length>0&&this.notifyChange("updating")}updateLogic(e){let t=!1;return this._sortedMaterialRenderers.forAll((({materialRenderer:r})=>{r.updateLogic&&r.updateLogic(e)&&(t=!0)})),t}render(e,t){for(let r=0;r<this._sortedMaterialRenderers.length;r++){const i=this._sortedMaterialRenderers.data[r];(0,$.Pb)(i.material,e)&&i.materialRenderer.render(null,e.pass,t,null)}}updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach(((t,r)=>{r.insertOrder=e++,this._sortedMaterialRenderers.push({material:r,materialRenderer:t})})),this._sortedMaterialRenderers.sort(((e,t)=>{const r=t.material.renderPriority-e.material.renderPriority;return 0!==r?r:e.material.insertOrder-t.material.insertOrder}))}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};(0,i._)([(0,u.Cb)()],de.prototype,"rctx",void 0),(0,i._)([(0,u.Cb)()],de.prototype,"materialRepository",void 0),(0,i._)([(0,u.Cb)()],de.prototype,"updating",null),de=(0,i._)([(0,p.j)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],de);class ce{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return 0===this.adds.size&&0===this.removes.size&&0===this.removed.size}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}var ue=r(54452),pe=r(23240),fe=r(97853),ge=r(44801),me=r(11379),ve=r(97111),_e=r(36904);class ye extends fe.A{initializeProgram(e){const t=ye.shader.get().build();return new ve.$(e.rctx,t,me.i)}initializePipeline(){return this.configuration.hasAlpha?(0,_e.sm)({blending:(0,_e.wK)(770,1,771,771),colorWrite:_e.BK}):(0,_e.sm)({colorWrite:_e.BK})}}ye.shader=new pe.J(ue.T,(()=>r.e(1225).then(r.bind(r,61225))));class xe extends ge.m{constructor(){super(...arguments),this.hasAlpha=!1}}(0,i._)([(0,ge.o)()],xe.prototype,"hasAlpha",void 0);class we{constructor(e=(0,m.c)()){this.intensity=e}}class be{constructor(e=(0,m.c)(),t=(0,m.f)(.57735,.57735,.57735)){this.intensity=e,this.direction=t}}class Te{constructor(e=(0,m.c)(),t=(0,m.f)(.57735,.57735,.57735),r=!0){this.intensity=e,this.direction=t,this.castShadows=r}}class Se{constructor(){this.r=[0],this.g=[0],this.b=[0]}}var Ce=r(17387);function Re(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t[i];return r}function Me(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]*t;return r}function Ee(e,t,r){(r=r||e).length=e.length;for(let i=0;i<e.length;i++)r[i]=e[i]+t[i];return r}function De(e){return(e+1)*(e+1)}function Pe(e,t,r){const i=e[0],s=e[1],n=e[2],a=r||[];return a.length=De(t),t>=0&&(a[0]=.28209479177),t>=1&&(a[1]=.4886025119*i,a[2]=.4886025119*n,a[3]=.4886025119*s),t>=2&&(a[4]=1.09254843059*i*s,a[5]=1.09254843059*s*n,a[6]=.31539156525*(3*n*n-1),a[7]=1.09254843059*i*n,a[8]=.54627421529*(i*i-s*s)),a}function Oe(e,t){const r=De(e),i=t||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let e=0;e<r;e++)i.r[e]=i.g[e]=i.b[e]=0;return i}function Ie(e,t){const r=function(e){return(0,_.uZ)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length);for(const i of e)(0,Ce.o)(Ne,i.direction),Pe(Ne,r,Fe),Re(Fe,je),Me(Fe,i.intensity[0],Ve),Ee(t.r,Ve),Me(Fe,i.intensity[1],Ve),Ee(t.g,Ve),Me(Fe,i.intensity[2],Ve),Ee(t.b,Ve);return t}function He(e,t){Pe(Ne,0,Fe);for(const r of e)t.r[0]+=Fe[0]*je[0]*r.intensity[0]*4*Math.PI,t.g[0]+=Fe[0]*je[0]*r.intensity[1]*4*Math.PI,t.b[0]+=Fe[0]*je[0]*r.intensity[2]*4*Math.PI;return t}const Ae=[],Le=[],ze=[],Fe=[0],Ve=[0],Ne=(0,m.c)(),je=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];class Ue{constructor(){this._shOrder=2,this._ambientBoost=.4,this._oldSunlight={direction:(0,m.c)(),ambient:{color:(0,m.c)(),intensity:1},diffuse:{color:(0,m.c)(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new Se,this._mainLight={intensity:(0,m.c)(),direction:(0,m.f)(1,0,0),castShadows:!1}}get lightingMainDirection(){return this._mainLight.direction}setLightDirectionUniform(e){e.setUniform3fv("lightingMainDirection",this._mainLight.direction)}setUniforms(e,t=!1){const r=t?(1-this.groundLightingFactor)*(1-this.globalFactor):0;e.setUniform1f("lightingFixedFactor",r),e.setUniform1f("lightingGlobalFactor",this.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._mainLight.intensity),e.setUniform1f("ambientBoostFactor",this._ambientBoost);const i=this._sphericalHarmonics;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",i.r[0],i.r[1],i.r[2],i.r[3]),e.setUniform4f("lightingAmbientSH_G",i.g[0],i.g[1],i.g[2],i.g[3]),e.setUniform4f("lightingAmbientSH_B",i.b[0],i.b[1],i.b[2],i.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",i.r[0],i.g[0],i.b[0]),e.setUniform4f("lightingAmbientSH_R1",i.r[1],i.r[2],i.r[3],i.r[4]),e.setUniform4f("lightingAmbientSH_G1",i.g[1],i.g[2],i.g[3],i.g[4]),e.setUniform4f("lightingAmbientSH_B1",i.b[1],i.b[2],i.b[3],i.b[4]),e.setUniform4f("lightingAmbientSH_R2",i.r[5],i.r[6],i.r[7],i.r[8]),e.setUniform4f("lightingAmbientSH_G2",i.g[5],i.g[6],i.g[7],i.g[8]),e.setUniform4f("lightingAmbientSH_B2",i.b[5],i.b[6],i.b[7],i.b[8]))}set(e){(function(e,t,r,i){Oe(t,i),(0,Ce.s)(r.intensity,0,0,0);let s=!1;const n=Ae,a=Le,o=ze;n.length=0,a.length=0,o.length=0;for(const t of e)t instanceof Te&&!s?((0,Ce.g)(r.direction,t.direction),r.intensity[0]=t.intensity[0],r.intensity[1]=t.intensity[1],r.intensity[2]=t.intensity[2],r.castShadows=t.castShadows,s=!0):t instanceof Te||t instanceof be?n.push(t):t instanceof we?a.push(t):t instanceof Se&&o.push(t);Ie(n,i),He(a,i);for(const e of o)Ee(i.r,e.r),Ee(i.g,e.g),Ee(i.b,e.b)})(e,this._shOrder,this._mainLight,this._sphericalHarmonics),(0,Ce.g)(this._oldSunlight.direction,this._mainLight.direction);const t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*t,(0,Ce.a)(this._oldSunlight.diffuse.color,this._mainLight.intensity,t),(0,Ce.g)(We,this._oldSunlight.diffuse.color),(0,Ce.a)(We,We,this._ambientBoost*this.globalFactor),(0,Ce.b)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,We)}get old(){return this._oldSunlight}}const We=(0,m.c)();class Ge{constructor(e){this._rctx=e,this.cache=new Map}dispose(){this.cache.forEach((e=>e.texture=(0,h.O3)(e.texture))),this.cache.clear()}acquire(e){if((0,h.Wi)(e))return null;const t=this.patternId(e),r=this.cache.get(t);if(r)return r.refCount++,r.bind;const i=this.patternToTextureData(e,2),s=i.length/2,n={refCount:1,texture:null,bind:e=>((0,h.Wi)(n.texture)&&(n.texture=new R.Z(this._rctx,{width:i.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},i)),e.bindTexture(n.texture,"stipplePatternTexture"),s)};return this.cache.set(t,n),n.bind}release(e){if((0,h.Wi)(e))return;const t=this.patternId(e),r=this.cache.get(t);r&&(r.refCount--,0===r.refCount&&((0,h.pC)(r.texture)&&r.texture.dispose(),this.cache.delete(t)))}swap(e,t){const r=this.acquire(t);return this.release(e),r}patternId(e){return e.join(",")}patternToTextureData(e,t){const r=e.reduce(((e,t)=>e+t))*t,i=new Uint8Array(r);let s=!0,n=0;for(const r of e){for(let e=0;e<r*t;e++)i[n++]=s?255:0;s=!s}return i}}var Be=r(28784);const ke=a.Z.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");let Ze=class extends((0,H.TF)(s.Z)){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._lighting=new Ue,this._handles=new n.Z,this._layerRenderers=new Map,this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers=new l.Z,this._geometries=new Map,this.globalUnitScale=1,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext,this._renderContext=new G(this._rctx);const t=e.waterTextureRepository;this._stippleTextureRepository=new Ge(e.renderingContext),this._shaderTechniqueRepository=new I({rctx:this._rctx,viewingMode:2,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._handles.add([(0,c.S1)(t,"loadingState",(()=>this.emitContentChanged())),(0,c.S1)(this,"spatialReference",(e=>this._localOrigins=new U.C(e)))]),this._materialRepository=new class{constructor(e,t,r){this._textureRep=e,this._techniqueRep=t,this.onMaterialChanged=r,this._id2glMaterialRef=new Map}dispose(){this._textureRep.dispose()}acquire(e,t){this.ownMaterial(e);const r=z(e.id,t);let i=this._id2glMaterialRef.get(r);if(null==i){const s=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return i=new N(s),i.incRefCnt(),this._id2glMaterialRef.set(r,i),s}return i.incRefCnt(),i.getGLMaterial()}release(e,t){const r=z(e.id,t),i=this._id2glMaterialRef.get(r);if(i.decRefCnt(),0===i.getRefCnt()){const e=i.getGLMaterial();e&&e.dispose(),this._id2glMaterialRef.delete(r)}}materialChanged(e){for(const t of L)if(5!==t.output&&6!==t.output){const r=this._id2glMaterialRef.get(z(e.id,t.output));if(r&&r.getGLMaterial()){const e=r.getGLMaterial();e.updateParameters&&e.updateParameters()}}this.onMaterialChanged&&this.onMaterialChanged(e)}ownMaterial(e){(0,h.pC)(e.materialRepository)&&e.materialRepository!==this&&V.error("Material is already owned by a different material repository"),e.materialRepository=this}}(e.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=e=>{(e.renderOccluded&Qe)>0!==this._rendersOccluded&&this.updateRendersOccluded(),this.emitContentChanged(),this.notifyChange("updating")},this._lighting.groundLightingFactor=1,this._lighting.globalFactor=0,this._lighting.set([new we((0,m.f)(1,1,1))]),this._bindParameters={slot:null,highlightDepthTexture:(0,j.hf)(this._rctx),camera:Je,inverseViewport:(0,g.a)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,lastFrameColorTexture:null,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!1,multipassGeometryEnabled:!1,highlightColorTexture:null},this._handles.add(this.view.resourceController.scheduler.registerTask(Be.T8.STAGE,this))}dispose(){this._handles.destroy(),this._layerRenderers.forEach((e=>e.dispose())),this._layerRenderers.clear(),this._debugTextureTechnique=(0,h.RY)(this._debugTextureTechnique),this._debugPatternTexture=(0,h.O3)(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=(0,h.O3)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=(0,h.O3)(this._shaderTechniqueRepository),this._temporaryFBO=(0,h.O3)(this._temporaryFBO),this._quadVAO=(0,h.O3)(this._quadVAO),this._overlayRenderTarget=(0,h.O3)(this._overlayRenderTarget)}get updating(){return this._sortedLayerRenderersDirty||(0,o.o)(this._layerRenderers,(e=>e.updating))}get hasOverlays(){return(0,h.pC)(this._overlays)&&(0,h.pC)(this._overlayRenderTarget)}get gpuMemoryUsage(){return(0,h.pC)(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}collectUnusedRenderTargetMemory(e){let t=!1;if((0,h.pC)(this._overlayRenderTarget))for(const r of this._overlayRenderTarget.renderTargets){const i=this.overlays[0].validTargets[r.type]||!this.overlays[1].validTargets[r.type];t=this._overlayRenderTarget.validateUsageForTarget(i,r,e)||t}return t}get overlays(){return(0,h.Pt)(this._overlays,[])}ensureDrapeTargets(e){(0,h.pC)(this._overlays)&&this._overlays.forEach((t=>{t.hasTargetWithoutRasterImage=(0,d.f)(e,(e=>1===e.drapeTargetType))}))}ensureDrapeSources(e){(0,h.pC)(this._overlays)&&this._overlays.forEach((t=>{t.hasDrapedFeatureSource=(0,o.o)(e,((e,t)=>1===t.drapeSourceType)),t.hasDrapedRasterSource=(0,o.o)(e,((e,t)=>0===t.drapeSourceType))}))}ensureOverlays(e,t){(0,h.Wi)(this._overlays)&&(this._overlayRenderTarget=new D(this._rctx),this._overlays=[new b(0,this._overlayRenderTarget),new b(1,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){(0,h.pC)(this._overlayRenderTarget)&&this._overlayRenderTarget.disposeRenderTargetMemory()}get running(){return this.updating}runTask(e,t=(()=>!0)){let r=!1;for(const[i,s]of this._layerRenderers){if(e.done)break;t(i)&&(s.commitChanges()&&(r=!0,e.madeProgress()),s.isEmpty&&(this._sortedLayerRenderersDirty=!0,this._layerRenderers.delete(i),this._handles.remove(i)))}this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),r=!0),r&&((0,h.pC)(this._overlays)&&0===this._layerRenderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}processSyncLayers(){this.runTask(Be.G5,(e=>1===e.updatePolicy))}addGeometries(e,t,r){for(const t of e)(0,h.Wi)(t.origin)&&(t.origin=this._localOrigins.getOrigin(t.boundingSphere)),this._geometries.set(t.id,t);this.ensureLayerRenderer(t).add(e),2===r&&this.notifyGraphicGeometryChanged(e,t)}removeGeometries(e,t,r){for(const t of e)this._geometries.delete((0,h.Wg)(t.id));const i=this._layerRenderers.get(t);i&&(i.remove(e),2===r&&this.notifyGraphicGeometryChanged(e,t))}updateGeometries(e,t,r){const i=this._layerRenderers.get(t);if(i)switch(i.modify(e,r),r){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else ke.warn("Attempted to update geometry for nonexistent layer")}notifyGraphicGeometryChanged(e,t){if((0,h.Wi)(t.notifyGraphicGeometryChanged))return;let r;for(const i of e){const e=i.graphicUid;(0,h.pC)(e)&&e!==r&&(t.notifyGraphicGeometryChanged(e),r=e)}}notifyGraphicVisibilityChanged(e,t){if((0,h.Wi)(t.notifyGraphicVisibilityChanged))return;let r;for(const i of e){const e=i.graphicUid;(0,h.pC)(e)&&e!==r&&(t.notifyGraphicVisibilityChanged(e),r=e)}}updateHighlights(e,t){const r=this._layerRenderers.get(t);r?r.modify(e,8):ke.warn("Attempted to update highlights for nonexistent layer")}isEmpty(){return 0===this._geometries.size&&!v.Z.OVERLAY_DRAW_DEBUG_TEXTURE}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateLogic(e){let t=!1;return this._layerRenderers.forEach((r=>{r.updateLogic(e)&&(t=!0)})),t}updateLayerOrder(){this._sortedLayerRenderersDirty=!0}drawTarget(e,t,r){const i=e.canvasGeometries;if(0===i.numViews)return!1;const s=e.pixelRatio*r;this._screenToWorldRatio=s*Math.abs(i.extents[0][2]-i.extents[0][0])/Math.abs(e.viewport[2]-e.viewport[0]);const n=t.renderPass;if(this.isEmpty()||5===n&&!this.hasHighlights||3===n&&!this.hasWater)return!1;if(!e.hasSomeSizedView())return!1;const a=t.fbo,o=2*e.resolution,l=e.resolution,d=1===t.type?2:4===t.type?1:0;if(!a.isValid())return!1;a.resize(o,l);const c=this._rctx;if(Je.pixelRatio=s||1,this._renderContext.pass=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,e.applyViewport(this._rctx),a.bind(c),0===e.index&&(c.setClearColor(0,0,0,0),c.clearSafe(16384)),1===d&&(this._renderContext.renderOccludedMask=Qe),v.Z.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==d)for(let t=0;t<i.numViews;t++)this.setViewParameters(i.extents[t],e,Je),this.drawDebugTexture(e.resolution,$e[e.index%$e.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((({layerView:t,renderer:r})=>{if(2===d&&(0,h.pC)(t)&&0===t.drapeSourceType)return;const s=(0,h.pC)(t)&&(0,h.pC)(t.fullOpacity)&&t.fullOpacity<1&&0===n;s&&(this.bindTemporaryFramebuffer(this._rctx,o,l),c.clearSafe(16384));for(let t=0;t<i.numViews;t++)this.setViewParameters(i.extents[t],e,Je),r.render(this._renderContext,this._bindParameters);s&&(0,h.pC)(this._temporaryFBO)&&(a.bind(c),this.view._stage.renderView.compositingHelper.composite(this._temporaryFBO.getTexture(),2,(0,h.Wg)((0,h.Wg)(t).fullOpacity),3,e.index))})),c.bindFramebuffer(null),a.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,r){(0,h.Wi)(this._temporaryFBO)&&(this._temporaryFBO=new E(e,!1)),this._temporaryFBO.resize(t,r),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.hotReload()}intersect(e,t,r){let i=0;this._geometries.forEach((s=>{if(r&&!r(s))return;this.intersectRenderGeometry(s,t,0,e,i);const n=this.longitudeCyclical;n&&(s.boundingSphere[0]-s.boundingSphere[3]<n.min&&this.intersectRenderGeometry(s,t,n.range,e,i),s.boundingSphere[0]+s.boundingSphere[3]>n.max&&this.intersectRenderGeometry(s,t,-n.range,e,i)),i++}))}intersectRenderGeometry(e,t,r,i,s){if(!e.instanceParameters.visible)return;let n=0;(0,h.pC)(e.transformation)&&(r+=e.transformation[12],n=e.transformation[13]),Ye[0]=t[0]-r,Ye[1]=t[1]-n,Ye[2]=1,Ke[0]=t[0]-r,Ke[1]=t[1]-n,Ke[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),i,Ye,Ke,((t,r,n)=>{this.addIntersectionResult(n,e.material.renderPriority,s,i,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)}addIntersectionResult(e,t,r,i,s,n){const a={type:"external",metadata:{layerUid:s,graphicUid:n}},o=s=>{s.set(a,null,i.results.ground.dist,i.results.ground.normal,i.results.ground.transformation,t,null,null,e,r),s.intersector="OverlayRenderer"};if((null==i.results.min.drapedLayerOrder||t>=i.results.min.drapedLayerOrder)&&(null==i.results.min.dist||i.results.ground.dist<=i.results.min.dist)&&o(i.results.min),0!==i.options.store&&(null==i.results.max.drapedLayerOrder||t<i.results.max.drapedLayerOrder)&&(null==i.results.max.dist||i.results.ground.dist>i.results.max.dist)&&o(i.results.max),2===i.options.store){const e=new W.xM(i.ray);o(e),i.results.all.push(e)}}stopAnimationsAtTime(e){this._sortedLayerRenderers.forAll((t=>t.renderer.stopAnimationsAtTime(e)))}ensureLayerRenderer(e){let t=this._layerRenderers.get(e);return t||(t=new de({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,t),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(()=>this.emitContentChanged())),e),this._handles.add((0,c.S1)(t,"updating",(()=>this.notifyChange("updating"))),e)),t}updateSortedLayerRenderers(){if(!this._sortedLayerRenderersDirty)return;if(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0===this._layerRenderers.size)return;const e=new Set(this._layerRenderers.values());this.view.allLayerViews.forEach((t=>{const r=t,i=this._layerRenderers.get(r);i&&(this._sortedLayerRenderers.push(new qe(r,i)),e.delete(i))})),e.forEach((e=>this._sortedLayerRenderers.push(new qe(null,e))))}setViewParameters(e,t,r){r.viewport=t.viewport,(0,f.o)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),(0,f.i)(r.viewMatrix),(0,f.t)(r.viewMatrix,r.viewMatrix,[-e[0],-e[1],0]),this._renderContext.camera=r,this._bindParameters.camera=r,this._bindParameters.inverseViewport[0]=1/r.fullViewport[2],this._bindParameters.inverseViewport[1]=1/r.fullViewport[3]}emitContentChanged(){this.onContentChanged&&this.onContentChanged()}updateHasWater(){const e=(0,o.o)(this._layerRenderers,(e=>e.hasWater));e!==this._hasWater&&(this._hasWater=e,this.onHasWaterChanged&&this.onHasWaterChanged(e))}updateHasHighlights(){const e=(0,o.o)(this._layerRenderers,(e=>e.hasHighlights));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}updateRendersOccluded(){const e=(0,o.o)(this._layerRenderers,(e=>e.rendersOccluded));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}drawDebugTexture(e,t){const r=this._rctx;this.ensureDebugPatternResources(e,e);const i=this._debugTextureTechnique.program;r.useProgram(i),r.setPipelineState(this._debugTextureTechnique.pipeline),i.setUniform4f("color",t[0],t[1],t[2],1),i.bindTexture(this._debugPatternTexture,"tex"),r.bindVAO(this._quadVAO),r.drawArrays(5,0,(0,se._V)(this._quadVAO,"geometry"))}ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const r=new Uint8Array(e*t*4);let i=0;for(let s=0;s<t;s++)for(let n=0;n<e;n++){const a=Math.floor(n/10),o=Math.floor(s/10);a<2||o<2||10*a>e-20||10*o>t-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&a&&1&o?1&n^1&s?0:255:1&a^1&o?0:128)}this._debugPatternTexture=new R.Z(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},r);const s=new xe;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(ye,s),this._quadVAO=(0,j.ow)(this._rctx)}get test(){return{layerRenderers:this._layerRenderers}}};(0,i._)([(0,H.gT)()],Ze.prototype,"_shaderTechniqueRepository",void 0),(0,i._)([(0,H.gT)()],Ze.prototype,"_stippleTextureRepository",void 0),(0,i._)([(0,u.Cb)({constructOnly:!0})],Ze.prototype,"view",void 0),(0,i._)([(0,u.Cb)()],Ze.prototype,"globalUnitScale",void 0),(0,i._)([(0,u.Cb)()],Ze.prototype,"spatialReference",void 0),(0,i._)([(0,u.Cb)({type:Boolean,readOnly:!0})],Ze.prototype,"updating",null),Ze=(0,i._)([(0,p.j)("esri.views.3d.terrain.OverlayRenderer")],Ze);class qe{constructor(e,t){this.layerView=e,this.renderer=t}}const $e=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],Je=new A.Z;Je.near=1,Je.far=1e4,Je.relativeElevation=null;const Ye=(0,m.c)(),Ke=(0,m.c)(),Xe=-2,Qe=4},31777:(e,t,r)=>{r.d(t,{q:()=>s});var i=r(33834);function s(e,t){0===t.output&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(i.H`void forwardLinearDepth() { linearDepth = gl_Position.w; }`)):1===t.output||3===t.output?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("cameraNearFar","vec2"),e.vertex.code.add(i.H`void forwardLinearDepth() {
linearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);
}`)):e.vertex.code.add(i.H`void forwardLinearDepth() {}`)}},11913:(e,t,r)=>{r.d(t,{E:()=>n,K:()=>s});var i=r(33834);function s(e){e.fragment.code.add(i.H`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function n(e){e.fragment.code.add(i.H`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}},83917:(e,t,r)=>{r.d(t,{n:()=>s});var i=r(33834);function s(e,t){1===t.viewingMode?e.vertex.code.add(i.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(i.H`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),1===t.viewingMode?e.vertex.code.add(i.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(i.H`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}},87023:(e,t,r)=>{r.d(t,{T:()=>a});var i=r(33834);function s(e){const t=e.fragment.code;t.add(i.H`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),t.add(i.H`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),t.add(i.H`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}var n=r(9295);function a(e,t){const r=e.fragment.code;e.include(n.e),3===t.pbrMode||4===t.pbrMode?(r.add(i.H`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),r.add(i.H`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),r.add(i.H`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),r.add(i.H`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),r.add(i.H`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)):1!==t.pbrMode&&2!==t.pbrMode||(e.include(s),r.add(i.H`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),r.add(i.H`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),r.add(i.H`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`),r.add(i.H`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),r.add(i.H`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),r.add(i.H`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}},71613:(e,t,r)=>{r.d(t,{hX:()=>n,O2:()=>a,mi:()=>h,vL:()=>o});var i=r(61017),s=r(33834);function n(e){e.fragment.include(i.n),e.fragment.uniforms.add("uShadowMapTex","sampler2D"),e.fragment.uniforms.add("uShadowMapNum","int"),e.fragment.uniforms.add("uShadowMapDistance","vec4"),e.fragment.uniforms.add("uShadowMapMatrix","mat4",4),e.fragment.uniforms.add("uDepthHalfPixelSz","float"),e.fragment.code.add(s.H`int chooseCascade(float _linearDepth, out mat4 mat) {
vec4 distance = uShadowMapDistance;
float depth = _linearDepth;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture2D(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
float texSize = 0.5 / halfPixelSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= uShadowMapNum) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);
}`)}function a(e,t){t.shadowMappingEnabled&&(t.shadowMap.bind(e),t.shadowMap.bindView(e,t.origin))}function o(e,t,r){t.shadowMappingEnabled&&t.shadowMap.bindView(e,r)}function h(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}},75619:(e,t,r)=>{r.d(t,{P:()=>a,O:()=>o});var i=r(4071),s=r(33834);function n(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(s.H`vec2 reprojectionCoordinate(vec3 projectionCoordinate)
{
vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
reprojectedCoord.xy /= reprojectedCoord.w;
return reprojectedCoord.xy * 0.5 + 0.5;
}`)}function a(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(i.S),e.include(n),e.fragment.code.add(s.H`
  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
          return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}function o(e,t){var r,i;t.ssrEnabled&&(e.bindTexture(t.linearDepthTexture,"depthMapView"),e.setUniform2fv("nearFar",t.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",t.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/t.camera.height),i=t,(r=e).bindTexture(i.lastFrameColorTexture,"lastFrameColorMap"),r.setUniformMatrix4fv("reprojectionMat",i.reprojectionMat),r.setUniformMatrix4fv("rpProjectionMat",i.camera.projectionMatrix))}},53584:(e,t,r)=>{r.d(t,{B:()=>h});var i=r(11913),s=r(33834);function n(e){e.fragment.code.add(s.H`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var a=r(87023),o=r(75619);function h(e,t){e.include(a.T,t),e.include(n),e.include(i.E),t.ssrEnabled&&e.include(o.P,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(s.H`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),e.fragment.code.add(s.H`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {
float reflectionHit = 0.;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}`),t.ssrEnabled?e.fragment.code.add(s.H`vec4 viewPosition = vec4(positionView.xyz, 1.0);
vec3 viewDir = normalize(viewPosition.xyz);
vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);
float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);
vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));
vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);
reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;
}
float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);
return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);
}`):e.fragment.code.add(s.H`return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);
}`)}},91123:(e,t,r)=>{r.d(t,{M:()=>n,b:()=>a});var i=r(11913),s=r(33834);function n(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(i.K),e.fragment.code.add(s.H`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}function a(e,t){e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},90168:(e,t,r)=>{r.d(t,{Z:()=>R});var i=r(36544),s=r(33655),n=r(59472),a=r(96071),o=r(67128),h=r(12811),l=r(14286),d=r(55735),c=r(17387),u=r(77625),p=r(34353),f=r(38256),g=r(17578),m=r(83679),v=r(69899),_=r(56469);const y=i.Z.getLogger("esri.views.3d.webgl-engine.lib.Camera");class x{constructor(e=null,t=null,r=null){this._viewUp=(0,u.c)(),this._viewForward=(0,u.c)(),this._viewRight=(0,u.c)(),this._ray=(0,m.Ue)(),this._viewport=(0,f.f)(0,0,1,1),this._padding=(0,f.f)(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=(0,d.f)(1,1e3),this._viewDirty=!0,this._viewMatrix=(0,h.c)(),this._projectionDirty=!0,this._projectionMatrix=(0,h.c)(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=(0,h.c)(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=(0,h.c)(),this._frustumDirty=!0,this._frustum=(0,g.Ue)(),this._fullViewport=(0,f.c)(),this.pixelRatio=1,this.relativeElevation=0,(0,n.pC)(e)&&(0,c.g)(this._ray.origin,e),this._center=(0,n.pC)(t)?(0,u.a)(t):(0,u.c)(),this._up=(0,n.pC)(r)?(0,u.a)(r):(0,u.f)(0,0,1)}get eye(){return this._ray.origin}set eye(e){this._compareAndSetView(e,this._ray.origin)}get center(){return this._center}set center(e){this._compareAndSetView(e,this._center)}get ray(){return(0,c.f)(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(e){this._compareAndSetView(e,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(e){(0,o.d)(this._viewMatrix,e),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(e){this._nearFar[0]!==e&&(this._nearFar[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(e){this._nearFar[1]!==e&&(this._nearFar[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(e){this.x=e[0],this.y=e[1],this.width=e[2],this.height=e[3]}get x(){return this._viewport[0]}set x(e){e+=this._padding[3],this._viewport[0]!==e&&(this._viewport[0]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(e){e+=this._padding[2],this._viewport[1]!==e&&(this._viewport[1]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(e){this._viewport[2]!==e&&(this._viewport[2]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(e){this._viewport[3]!==e&&(this._viewport[3]=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[1]+this._padding[3]}set fullWidth(e){this.width=e-(this._padding[1]+this._padding[3])}get fullHeight(){return this._viewport[3]+this._padding[0]+this._padding[2]}set fullHeight(e){this.height=e-(this._padding[0]+this._padding[2])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[3],this._fullViewport[1]=this._viewport[1]-this._padding[2],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(e){this._padding[0]===e[0]&&this._padding[1]===e[1]&&this._padding[2]===e[2]&&this._padding[3]===e[3]||(this._viewport[0]+=e[3]-this._padding[3],this._viewport[1]+=e[2]-this._padding[2],this._viewport[2]-=e[1]+e[3]-(this._padding[1]+this._padding[3]),this._viewport[3]-=e[0]+e[2]-(this._padding[0]+this._padding[2]),(0,p.c)(this._padding,e),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&((0,o.m)(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const e=this.width,t=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this.aspect;(0,o.k)(this._projectionMatrix,-i*(1+2*this._padding[3]/e),i*(1+2*this._padding[1]/e),-r*(1+2*this._padding[2]/t),r*(1+2*this._padding[0]/t),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}set projectionMatrix(e){(0,o.d)(this._projectionMatrix,e),this._projectionDirty=!1,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(e){this._fov=e,this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return(0,_.tM)(this._fov,this.width,this.height)}set fovX(e){this._fov=(0,_.Kj)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return(0,_.RQ)(this._fov,this.width,this.height)}set fovY(e){this._fov=(0,_.zF)(e,this.width,this.height),this._projectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return(0,c.i)(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&((0,o.a)(this._viewInverseTransposeMatrix,this.viewMatrix),(0,o.e)(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(e){const t=2*e-1;return 2*this.near*this.far/(this.far+this.near-t*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(e){(0,c.g)(this._ray.origin,e.eye),(0,c.g)(this._center,e.center),(0,c.g)(this._up,e.up),(0,p.c)(this._viewport,e.viewport),(0,p.c)(this._padding,e.padding),(0,l.c)(this._nearFar,e.nearFar),this._fov=e.fov,this.relativeElevation=e.relativeElevation;const t=e;return this._viewDirty=t._viewDirty,this._viewDirty||((0,o.d)(this._viewMatrix,e.viewMatrix),(0,c.g)(this._viewRight,e.viewRight),(0,c.g)(this._viewUp,e.viewUp),(0,c.g)(this._viewForward,e.viewForward)),t._projectionDirty?this._projectionDirty=!0:((0,o.d)(this._projectionMatrix,e.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._frustumDirty=t._frustumDirty,this._frustumDirty||((0,g.JG)(e.frustum,this._frustum),this._frustumDirty=!1),t._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:((0,o.d)(this._viewInverseTransposeMatrix,e.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),(0,p.c)(this._fullViewport,e.fullViewport),this.pixelRatio=e.pixelRatio,this}copyViewFrom(e){this.eye=e.eye,this.center=e.center,this.up=e.up}clone(){return(new x).copyFrom(this)}equals(e){return(0,c.k)(this.eye,e.eye)&&(0,c.k)(this._center,e.center)&&(0,c.k)(this._up,e.up)&&(0,p.g)(this._viewport,e.viewport)&&(0,p.g)(this._padding,e.padding)&&(0,l.k)(this._nearFar,e.nearFar)&&this._fov===e.fov&&this.pixelRatio===e.pixelRatio&&this.relativeElevation===e.relativeElevation}almostEquals(e){if(this.pixelRatio!==e.pixelRatio||Math.abs(e.fov-this._fov)>=.001)return!1;const t=5e-4;(0,c.w)(T,e.eye,e.center),(0,c.w)(S,this.eye,this._center);const r=(0,c.d)(T,S),i=(0,c.x)(T),s=(0,c.x)(S);return r*r>=(1-1e-10)*i*s&&(0,c.y)(e.eye,this.eye)<Math.max(i,s)*t*t&&(0,p.i)(e.padding,this._padding)<.5&&(0,p.i)(e.viewport,this._viewport)<.5}computeRenderPixelSizeAt(e){return this.computeRenderPixelSizeAtDist(this.viewDirectionDistance(e))}computeRenderPixelSizeAtDist(e){return e*this.perRenderPixelRatio}computeScreenPixelSizeAt(e){return this.computeScreenPixelSizeAtDist(this.viewDirectionDistance(e))}viewDirectionDistance(e){return Math.abs((0,v.SR)(this.viewForward,(0,c.f)(T,e,this.eye)))}computeScreenPixelSizeAtDist(e){return e*this.perScreenPixelRatio}computeDistanceFromRadius(e,t){return e/Math.tan(Math.min(this.fovX,this.fovY)/(2*(t||1)))}getScreenCenter(e=(0,a.s1)()){return e[0]=(this.padding[3]+this.width/2)/this.pixelRatio,e[1]=(this.padding[0]+this.height/2)/this.pixelRatio,e}getRenderCenter(e,t=.5,r=.5){return e||(e=(0,a.J$)()),e[0]=this.padding[3]+this.width*t,e[1]=this.padding[2]+this.height*r,e.length>2&&(e[2]=.5),e}setGLViewport(e){const t=this.viewport,r=this.padding;e.setViewport(t[0]-r[3],t[1]-r[2],t[2]+r[1]+r[3],t[3]+r[0]+r[2])}applyProjection(e,t,r=!1){e!==w&&(0,c.g)(w,e),w[3]=1,r&&(t[2]=-w[2]),(0,p.t)(w,w,this.projectionMatrix),(0,c.a)(w,w,1/Math.abs(w[3]));const i=this.fullViewport;return t[0]=(0,s.t7)(0,i[0]+i[2],.5+.5*w[0]),t[1]=(0,s.t7)(0,i[1]+i[3],.5+.5*w[1]),r||(t[2]=.5*(w[2]+1)),t}projectToScreen(e,t){this.projectToRenderScreen(e,C),this.renderToScreen(C,t)}projectToRenderScreen(e,t){if(w[0]=e[0],w[1]=e[1],w[2]=e[2],w[3]=1,(0,p.t)(w,w,this.viewProjectionMatrix),0===w[3])return null;(0,c.a)(w,w,1/Math.abs(w[3]));const r=this.fullViewport;return"x"in t?(t.x=(0,s.t7)(0,r[0]+r[2],.5+.5*w[0]),t.y=(0,s.t7)(0,r[1]+r[3],.5+.5*w[1])):(t[0]=(0,s.t7)(0,r[0]+r[2],.5+.5*w[0]),t[1]=(0,s.t7)(0,r[1]+r[3],.5+.5*w[1]),t.length>2&&(t[2]=.5*(w[2]+1))),t}unprojectFromScreen(e,t){return this.unprojectFromRenderScreen(this.screenToRender(e,C),t)}unprojectFromRenderScreen(e,t){if((0,o.m)(b,this.projectionMatrix,this.viewMatrix),!(0,o.a)(b,b))return null;const r=this.fullViewport;return w[0]=2*(e[0]-r[0])/r[2]-1,w[1]=2*(e[1]-r[1])/r[3]-1,w[2]=2*e[2]-1,w[3]=1,(0,p.t)(w,w,b),0===w[3]?null:(t[0]=w[0]/w[3],t[1]=w[1]/w[3],t[2]=w[2]/w[3],t)}constrainWindowSize(e,t,r,i=r){const s=e*this.pixelRatio,n=t*this.pixelRatio,a=Math.max(s-r/2,0),o=Math.max(this.fullHeight-n-i/2,0),h=-Math.min(s-r/2,0),l=-Math.min(this.fullHeight-n-i/2,0);return[a,o,r-h- -Math.min(this.fullWidth-s-r/2,0),i-l- -Math.min(n-i/2,0)]}computeUp(e){1===e?this.computeUpGlobal():this.computeUpLocal()}screenToRender(e,t){const r=e[0]*this.pixelRatio,i=this.fullHeight-e[1]*this.pixelRatio;return t[0]=r,t[1]=i,t}renderToScreen(e,t){const r=e[0]/this.pixelRatio,i=(this.fullHeight-e[1])/this.pixelRatio;t[0]=r,t[1]=i}computeUpGlobal(){(0,c.f)(T,this.center,this.eye);const e=(0,c.l)(this.center);e<1?((0,c.s)(this._up,0,0,1),this._markViewDirty()):Math.abs((0,c.d)(T,this.center))>.9999*(0,c.l)(T)*e||((0,c.c)(this._up,T,this.center),(0,c.c)(this._up,this._up,T),(0,c.n)(this._up,this._up),this._markViewDirty())}computeUpLocal(){(0,c.r)(T,this.eye,this.center),Math.abs(T[2])<=.9999&&((0,c.a)(T,T,T[2]),(0,c.s)(this._up,-T[0],-T[1],1-T[2]),(0,c.n)(this._up,this._up),this._markViewDirty())}_compareAndSetView(e,t){"number"==typeof e[0]&&isFinite(e[0])&&"number"==typeof e[1]&&isFinite(e[1])&&"number"==typeof e[2]&&isFinite(e[2])?(0,c.k)(e,t)||((0,c.g)(t,e),this._markViewDirty()):y.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&((0,g.q_)(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&((0,o.l)(this._viewMatrix,this.eye,this._center,this._up),(0,c.s)(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),(0,c.s)(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),(0,c.s)(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const w=(0,f.c)(),b=(0,h.c)(),T=(0,u.c)(),S=(0,u.c)(),C=(0,a.J$)(),R=x},26899:(e,t,r)=>{r.d(t,{C:()=>f});var i=r(59472),s=r(12811),n=r(17387),a=r(77625),o=r(28449),h=r(68500),l=r(60245),d=r(88909),c=r(42722),u=r(94899);let p=0;class f{constructor(e){this._originSR=e,this.ROOT_ORIGIN_ID="rg_root_"+p++,this._origins=new Map,this._gridSize=125e4,this._objects=new Map}getOrigin(e){const t=this._origins.get(this.ROOT_ORIGIN_ID);if(null==t){if((0,i.pC)(g))return this._origins.set(this.ROOT_ORIGIN_ID,(0,l.al)(g[0],g[1],g[2],this.ROOT_ORIGIN_ID)),this.getOrigin(e);const t=(0,l.al)(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,t),t}const r=this._gridSize,s=Math.round(e[0]/r),a=Math.round(e[1]/r),o=Math.round(e[2]/r),h=`rg_${s}/${a}/${o}`;let d=this._origins.get(h);const c=.5*r;if((0,n.f)(m,e,t.vec3),m[0]=Math.abs(m[0]),m[1]=Math.abs(m[1]),m[2]=Math.abs(m[2]),m[0]<c&&m[1]<c&&m[2]<c){if(d){const t=Math.max(...m);if((0,n.f)(m,e,d.vec3),m[0]=Math.abs(m[0]),m[1]=Math.abs(m[1]),m[2]=Math.abs(m[2]),Math.max(...m)<t)return d}return t}return d||(d=(0,l.al)(s*r,a*r,o*r,h),this._origins.set(h,d)),d}_drawOriginBox(e,t=[1,1,0,1]){const r=window.view,i=r._stage,n=t.toString();if(!this._objects.has(n)){this._material=new u.U({width:2,color:t}),i.add(this._material);const e=new c.F({isPickable:!1}),r=new d.T({castShadow:!1});i.add(r),e.add(r),i.add(e),this._objects.set(n,r)}const a=this._objects.get(n),l=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],p=l.length,f=new Array(3*p),g=new Uint16Array(2*(p-1)),m=.5*this._gridSize;for(let t=0;t<p;t++)f[3*t+0]=e[0]+(1&l[t]?m:-m),f[3*t+1]=e[1]+(2&l[t]?m:-m),f[3*t+2]=e[2]+(4&l[t]?m:-m),t>0&&(g[2*t+0]=t-1,g[2*t+1]=t);(0,o.CM)(f,this._originSR,0,f,r.renderSpatialReference,0,p);const v=new h.Z([["position",{size:3,data:f,exclusive:!0}]],[["position",g]],2);i.add(v),a.addGeometry(v,this._material,s.I)}get test(){const e=this;return{get gridSize(){return e._gridSize},set gridSize(t){e._gridSize=t}}}}let g=null;const m=(0,a.c)()},86325:(e,t,r)=>{r.d(t,{r:()=>p}),r(95830);var i=r(59472),s=r(12811),n=r(17387),a=r(77625),o=r(83679);class h{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=2}}var l=r(81495),d=r(55666),c=r(49366);const u=1e-5;class p{constructor(e){this.options=new h,this.results=new l.LV,this.transform=new d.yn,this.performanceInfo={queryDuration:0,numObjectsTested:0},this.tolerance=u,this.verticalOffset=null,this._ray={origin:(0,a.c)(),direction:(0,a.c)()},this._rayEndPoint=(0,a.c)(),this._rayStartPointTransformed=(0,a.c)(),this._rayEndPointTransformed=(0,a.c)(),this.viewingMode=null==e?1:e}get ray(){return this._ray}get rayBeginPoint(){return this._ray.origin}get rayEndPoint(){return this._rayEndPoint}reset(e,t){this.resetWithRay((0,o.zk)(e,t,this._ray))}resetWithRay(e){e!==this._ray&&(0,o.JG)(e,this._ray),0!==this.options.verticalOffset?2===this.viewingMode?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,(0,n.b)(this._rayEndPoint,this._ray.origin,this._ray.direction),this._numObjectsTested=0,this.results.init(this._ray)}intersect(e=null,t,r,s,n,a){this.point=t,this.camera=r,this.filterPredicate=n,this.tolerance=null==s?u:s;const o=(0,d.W9)(this.verticalOffset);if((0,i.pC)(e)&&e.length>0){const t=a?e=>{a(e)&&this.intersectObject(e)}:e=>{this.intersectObject(e)};for(const r of e){const e=r.getSpatialQueryAccelerator&&r.getSpatialQueryAccelerator();(0,i.pC)(e)?((0,i.pC)(o)?e.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,t,o):e.forEachAlongRay(this._ray.origin,this._ray.direction,t),this.options.selectionMode&&this.options.hud&&e.forEachDegenerateObject(t)):r.objects.forAll((e=>t(e)))}}this.sortResults()}intersectObject(e){this._numObjectsTested++;const t=e.geometryRecords;if(!t)return;const r=e.id,a=e.transformation;let o;const h=(0,d.W9)(this.verticalOffset);for(const d of t){const{geometry:t,material:u,instanceParameters:p}=d;if((0,c.PD)(p))continue;o=t.id,this.transform.setAndInvalidateLazyTransforms(a,d.getShaderTransformation()),(0,n.m)(this._rayStartPointTransformed,this._ray.origin,this.transform.inverse),(0,n.m)(this._rayEndPointTransformed,this._rayEndPoint,this.transform.inverse);const f=this.transform.transform;(0,i.pC)(h)&&(h.objectTransform=this.transform),u.intersect(t,p,this.transform.transform,this,this._rayStartPointTransformed,this._rayEndPointTransformed,((t,n,a,h,d,c)=>{if(t>=0){if((0,i.pC)(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEndPoint,t))return;const u=`Object3D ${r}`;if(d)return void((null==this.results.hud.dist||t<this.results.hud.dist)&&this.results.hud.set(e,u,t,n,s.I,h,c,o,a));const p=r=>r.set(e,u,t,n,f,h,null,o,a);if((null==this.results.min.drapedLayerOrder||h>=this.results.min.drapedLayerOrder)&&(null==this.results.min.dist||t<this.results.min.dist)&&p(this.results.min),0!==this.options.store&&(null==this.results.max.drapedLayerOrder||h<this.results.max.drapedLayerOrder)&&(null==this.results.max.dist||t>this.results.max.dist)&&p(this.results.max),2===this.options.store){const e=new l.xM(this._ray);p(e),this.results.all.push(e)}}}),d.shaderTransformation)}}sortResults(){this.results.all.sort(((e,t)=>e.dist!==t.dist?e.dist-t.dist:e.drapedLayerOrder!==t.drapedLayerOrder?(void 0!==e.drapedLayerOrder?e.drapedLayerOrder:Number.MAX_VALUE)-(void 0!==t.drapedLayerOrder?t.drapedLayerOrder:Number.MAX_VALUE):(void 0!==t.drapedLayerGraphicOrder?t.drapedLayerGraphicOrder:Number.MIN_VALUE)-(void 0!==e.drapedLayerGraphicOrder?e.drapedLayerGraphicOrder:Number.MIN_VALUE)))}}p.DEFAULT_TOLERANCE=u},51869:(e,t,r)=>{r.d(t,{z:()=>p});var i=r(59472),s=r(32366),n=r(67128),a=r(12811),o=r(17387),h=r(38256),l=r(17154),d=r(57265),c=r(85450),u=r(49366);class p{constructor(e,t,r=null,i=null,n=(0,s.D)(),o=null,l=null,d=!1){this.data=e,this.material=t,this.layerUid=r,this.graphicUid=i,this.id=n,this.boundingInfo=o,this.calculateShaderTransformation=l,this.castShadow=d,this.boundingSphere=(0,h.c)(),this.instanceParameters={highlights:null,occludees:null,visible:!0},this._transformation=(0,a.c)(),this._shaderTransformationDirty=!0}get transformation(){return this._transformation}updateTransformation(e){e(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(e,t,r=(0,l.u1)(e)){(0,i.Wi)(this.boundingInfo)||((0,o.m)(t,this.boundingInfo.getCenter(),e),t[3]=this.boundingInfo.getBSRadius()*r)}get hasShaderTransformation(){return(0,i.pC)(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return(0,i.Wi)(this.calculateShaderTransformation)?(0,i.Pt)(this.transformation,a.I):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=(0,a.c)()),(0,n.d)(this._shaderTransformation,this.calculateShaderTransformation((0,i.Pt)(this.transformation,a.I))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(e){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,e)&&((0,i.pC)(this._transformation)&&(0,o.m)(e,e,this._transformation),!0);const t=this.indices.get("position"),r=this.vertexAttributes.get("position");return!!(0,d.cM)(r,t,e)&&((0,i.pC)(this._transformation)&&(0,o.m)(e,e,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const e=new c.O(0),t=this.instanceParameters;return t.highlights=(0,u.lr)(t.highlights,e),e}removeHighlight(e){const t=this.instanceParameters;t.highlights=(0,u.U_)(t.highlights,e)}}},81495:(e,t,r)=>{r.d(t,{xM:()=>u,LV:()=>c});var i=r(67128),s=r(12811),n=r(17387),a=r(77625),o=r(34353),h=r(38256),l=(r(55534),r(83679)),d=r(88909);class c{constructor(){this.min=new u,this.max=new u,this.hud=new u,this.ground=new u}init(e){this.min.init(e),this.max.init(e),this.hud.init(e),this.ground.init(e),this.all=[]}}class u{constructor(e){this.normal=(0,a.c)(),this.transformation=(0,s.c)(),this._ray=(0,l.Ue)(),this.init(e)}get ray(){return this._ray}get hasIntersectionPoint(){return null!=this.dist}get distanceInRenderSpace(){if(null!=this.dist)return(0,n.a)(p,this.ray.direction,this.dist),(0,n.l)(p)}getIntersectionPoint(e){return!!this.hasIntersectionPoint&&((0,n.a)(p,this.ray.direction,this.dist),(0,n.b)(e,this.ray.origin,p),!0)}getTransformedNormal(e){return(0,n.g)(f,this.normal),f[3]=0,(0,o.t)(f,f,this.transformation),(0,n.g)(e,f),(0,n.n)(e,e),e}init(e){this.dist=void 0,this.target=void 0,this.name=void 0,this.drapedLayerOrder=void 0,this.drapedLayerGraphicOrder=void 0,this.center=null,this.geometryId=null,this.triangleNr=null,this.intersector="Stage",e?(0,l.JG)(e,this._ray):this._ray=(0,l.Ue)()}set(e,t,r,s,o,h,l,c,u,p){e instanceof d.T&&(e={type:"stage",obj:e}),this.dist=r,(0,n.g)(this.normal,s),(0,i.d)(this.transformation,o),this.target=e,this.name=t,this.drapedLayerOrder=h,this.center=l?(0,a.a)(l):null,this.geometryId=c,this.triangleNr=u,this.drapedLayerGraphicOrder=p}copyFrom(e){(0,l.JG)(e.ray,this._ray),this.dist=e.dist,this.target=e.target,this.name=e.name,this.drapedLayerOrder=e.drapedLayerOrder,this.center=e.center?(0,a.a)(e.center):null,this.geometryId=e.geometryId,this.triangleNr=e.triangleNr,this.intersector=e.intersector,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,(0,n.g)(this.normal,e.normal),(0,i.d)(this.transformation,e.transformation)}}(0,a.c)();const p=(0,a.c)(),f=(0,h.c)()},60245:(e,t,r)=>{r.d(t,{al:()=>n});var i=r(77625);class s{constructor(e,t){this.vec3=e,this.id=t}}function n(e,t,r,n){return new s((0,i.f)(e,t,r),n)}},55666:(e,t,r)=>{r.d(t,{yn:()=>g,W9:()=>_});var i=r(59472),s=r(98501),n=r(30663),a=r(67128),o=r(12811),h=r(2847),l=r(32232),d=r(17387),c=r(69236),u=r(77625),p=r(38256),f=r(13633);class g{constructor(){this._transform=(0,o.c)(),this._transformInverse=new m({value:this._transform},a.a,o.c),this._transformInverseTranspose=new m(this._transformInverse,a.e,o.c),this._transformTranspose=new m({value:this._transform},a.e,o.c),this._transformInverseRotation=new m({value:this._transform},s.n,n.c)}invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){(0,a.d)(this._transform,e)}multiplyTransform(e){(0,a.m)(this._transform,this._transform,e)}set(e){(0,a.d)(this._transform,e),this.invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,t){this.setTransformMatrix(e),this.multiplyTransform(t),this.invalidateLazyTransforms()}}class m{constructor(e,t,r){this.original=e,this.update=t,this.dirty=!0,this.transform=r()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}const v=new class{constructor(e=0){this.offset=e,this.sphere=(0,f.c)(),this.tmpVertex=(0,u.c)()}applyToVertex(e,t,r){const i=this.objectTransform.transform;let s=i[0]*e+i[4]*t+i[8]*r+i[12],n=i[1]*e+i[5]*t+i[9]*r+i[13],a=i[2]*e+i[6]*t+i[10]*r+i[14];const o=this.offset/Math.sqrt(s*s+n*n+a*a);s+=s*o,n+=n*o,a+=a*o;const h=this.objectTransform.inverse;return this.tmpVertex[0]=h[0]*s+h[4]*n+h[8]*a+h[12],this.tmpVertex[1]=h[1]*s+h[5]*n+h[9]*a+h[13],this.tmpVertex[2]=h[2]*s+h[6]*n+h[10]*a+h[14],this.tmpVertex}applyToMinMax(e,t){const r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*r,e[1]+=e[1]*r,e[2]+=e[2]*r;const i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*i,t[1]+=t[1]*i,t[2]+=t[2]*i}applyToAabb(e){const t=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*t,e[1]+=e[1]*t,e[2]+=e[2]*t;const r=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*r,e[4]+=e[4]*r,e[5]+=e[5]*r,e}applyToBoundingSphere(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),r=this.offset/t;return this.sphere[0]=e[0]+e[0]*r,this.sphere[1]=e[1]+e[1]*r,this.sphere[2]=e[2]+e[2]*r,this.sphere[3]=e[3]+e[3]*this.offset/t,this.sphere}};function _(e){return(0,i.pC)(e)?(v.offset=e,v):null}new class{constructor(e=0){this.offset=e,this.componentLocalOriginLength=0,this.tmpVertex=(0,u.c)(),this.mbs=(0,p.c)(),this.obb={center:(0,u.c)(),halfSize:(0,c.c)(),quaternion:null}}set localOrigin(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}applyToVertex(e,t,r){const i=e,s=t,n=r+this.componentLocalOriginLength,a=this.offset/Math.sqrt(i*i+s*s+n*n);return this.tmpVertex[0]=e+i*a,this.tmpVertex[1]=t+s*a,this.tmpVertex[2]=r+n*a,this.tmpVertex}applyToAabb(e){const t=e[0],r=e[1],i=e[2]+this.componentLocalOriginLength,s=e[3],n=e[4],a=e[5]+this.componentLocalOriginLength,o=this.offset/Math.sqrt(t*t+r*r+i*i);e[0]+=t*o,e[1]+=r*o,e[2]+=i*o;const h=this.offset/Math.sqrt(s*s+n*n+a*a);return e[3]+=s*h,e[4]+=n*h,e[5]+=a*h,e}applyToMbs(e){const t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),r=this.offset/t;return this.mbs[0]=e[0]+e[0]*r,this.mbs[1]=e[1]+e[1]*r,this.mbs[2]=e[2]+e[2]*r,this.mbs[3]=e[3]+e[3]*this.offset/t,this.mbs}applyToObb(e){const t=e.center,r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);this.obb.center[0]=t[0]+t[0]*r,this.obb.center[1]=t[1]+t[1]*r,this.obb.center[2]=t[2]+t[2]*r,(0,d.q)(this.obb.halfSize,e.halfSize,e.quaternion),(0,d.b)(this.obb.halfSize,this.obb.halfSize,e.center);const i=this.offset/Math.sqrt(this.obb.halfSize[0]*this.obb.halfSize[0]+this.obb.halfSize[1]*this.obb.halfSize[1]+this.obb.halfSize[2]*this.obb.halfSize[2]);return this.obb.halfSize[0]+=this.obb.halfSize[0]*i,this.obb.halfSize[1]+=this.obb.halfSize[1]*i,this.obb.halfSize[2]+=this.obb.halfSize[2]*i,(0,d.f)(this.obb.halfSize,this.obb.halfSize,e.center),(0,h.c)(y,e.quaternion),(0,d.q)(this.obb.halfSize,this.obb.halfSize,y),this.obb.halfSize[0]*=this.obb.halfSize[0]<0?-1:1,this.obb.halfSize[1]*=this.obb.halfSize[1]<0?-1:1,this.obb.halfSize[2]*=this.obb.halfSize[2]<0?-1:1,this.obb.quaternion=e.quaternion,this.obb}},new class{constructor(e=0){this.offset=e,this.tmpVertex=(0,u.c)()}applyToVertex(e,t,r){const i=e+this.localOrigin[0],s=t+this.localOrigin[1],n=r+this.localOrigin[2],a=this.offset/Math.sqrt(i*i+s*s+n*n);return this.tmpVertex[0]=e+i*a,this.tmpVertex[1]=t+s*a,this.tmpVertex[2]=r+n*a,this.tmpVertex}applyToAabb(e){const t=e[0]+this.localOrigin[0],r=e[1]+this.localOrigin[1],i=e[2]+this.localOrigin[2],s=e[3]+this.localOrigin[0],n=e[4]+this.localOrigin[1],a=e[5]+this.localOrigin[2],o=this.offset/Math.sqrt(t*t+r*r+i*i);e[0]+=t*o,e[1]+=r*o,e[2]+=i*o;const h=this.offset/Math.sqrt(s*s+n*n+a*a);return e[3]+=s*h,e[4]+=n*h,e[5]+=a*h,e}};const y=(0,l.a)()},58599:(e,t,r)=>{r.d(t,{Y:()=>L});var i=r(36544),s=r(59472),n=r(96071),a=r(14286),o=r(17387),h=r(77625),l=r(34720),d=r(37871),c=r(57805),u=r(57265),p=r(26701),f=r(10762),g=r(56469),m=r(13405),v=r(6048),_=r(30090),y=r(49366),x=r(56140),w=r(61514),b=r(72023),T=r(89553),S=r(23240),C=r(97853),R=r(44801),M=r(11379),E=r(97111),D=r(38391),P=r(31343),O=r(36904);class I extends C.A{constructor(e,t,r){super(e,t,r),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=e.stippleTextureRepository}initializeProgram(e){const t=I.shader.get(),r=this.configuration,i=t.build({output:r.output,attributeColor:r.vertexColors,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,stippleEnabled:r.stippleEnabled,stippleOffColorEnabled:r.stippleOffColorEnabled,stippleUVMaxEnabled:!1,stippleIntegerRepeatsEnabled:r.stippleIntegerRepeatsEnabled});return new E.$(e.rctx,i,M.i)}dispose(){super.dispose(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(e,t){if((0,T.II)(this.program,t.camera.projectionMatrix),this.stipplePattern!==e.stipplePattern){const t=e.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,t),this.stipplePattern=t}if(this.configuration.stippleEnabled){const e=(0,s.pC)(this.stippleTextureBind)?this.stippleTextureBind(this.program)*t.camera.pixelRatio:1;this.program.setUniform1i("stipplePatternTexture",0),this.program.setUniform1f("stipplePatternPixelSizeInv",1/e),this.program.setUniform2f("ndcToPixel",t.camera.fullViewport[2]/2,t.camera.fullViewport[3]/2)}if(this.program.setUniform4fv("constantColor",e.color),this.program.setUniform1f("alphaCoverage",Math.min(1,e.width*t.camera.pixelRatio)),this.configuration.stippleOffColorEnabled){const t=(0,s.Wg)(e.stippleOffColor);this.program.setUniform4f("stippleOffColor",t[0],t[1],t[2],t.length>3?t[3]:1)}4===this.configuration.output&&(0,b.wW)(this.program,t)}bindDraw(e){(0,T.id)(this.program,e),(0,w.DA)(this.program,this.configuration,e),this.program.rebindTextures()}initializePipeline(){const e=this.configuration,t=(0,O.wK)(770,1,771,771),r=(t,r=null,i=null)=>(0,O.sm)({blending:r,depthTest:D.JN,depthWrite:i,colorWrite:O.BK,stencilWrite:e.sceneHasOcludees?D.s3:null,stencilTest:e.sceneHasOcludees?t?D.eD:D.RY:null});return 0===e.output?(this._occludeePipelineState=r(!0,e.transparent||e.stippleEnabled?t:null,O.LZ),r(!1,e.transparent||e.stippleEnabled?t:null,O.LZ)):r(!1)}get primitiveType(){return 1}getPipelineState(e){return e?this._occludeePipelineState:this.pipeline}}I.shader=new S.J(P.N,(()=>r.e(9979).then(r.bind(r,49979))));class H extends R.m{constructor(){super(...arguments),this.output=0,this.slicePlaneEnabled=!1,this.vertexColors=!1,this.transparent=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleIntegerRepeatsEnabled=!1,this.sceneHasOcludees=!1}}(0,x._)([(0,R.o)({count:8})],H.prototype,"output",void 0),(0,x._)([(0,R.o)()],H.prototype,"slicePlaneEnabled",void 0),(0,x._)([(0,R.o)()],H.prototype,"vertexColors",void 0),(0,x._)([(0,R.o)()],H.prototype,"transparent",void 0),(0,x._)([(0,R.o)()],H.prototype,"stippleEnabled",void 0),(0,x._)([(0,R.o)()],H.prototype,"stippleOffColorEnabled",void 0),(0,x._)([(0,R.o)()],H.prototype,"stippleIntegerRepeatsEnabled",void 0),(0,x._)([(0,R.o)()],H.prototype,"sceneHasOcludees",void 0);const A=i.Z.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");class L extends f.F5{constructor(e){super(e,V),this.techniqueConfig=new H}getTechniqueConfig(e){this.techniqueConfig.output=e,this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled,this.techniqueConfig.vertexColors=this.params.vertexColors,this.techniqueConfig.transparent=this.params.color[3]<1||this.params.width<1;const t=(0,s.pC)(this.params.stipplePattern);return this.techniqueConfig.stippleEnabled=t,this.techniqueConfig.stippleOffColorEnabled=t&&(0,s.pC)(this.params.stippleOffColor),this.techniqueConfig.stippleIntegerRepeatsEnabled=t&&this.params.stippleIntegerRepeats,this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees,this.techniqueConfig}getPassParameters(){return this.params}intersect(e,t,r,i,s,n,a,o,h){h?(0,_.TT)(e,i,n,1,a):this.intersectLineGeometry(e,t,r,i,a)}intersectLineGeometry(e,t,r,i,s){if(!i.options.selectionMode||(0,y.PD)(t))return;if(!(0,g.kG)(r))return void A.error("intersection assumes a translation-only matrix");const n=e.vertexAttributes.get("position").data,h=i.camera,c=J;(0,a.c)(c,i.point),(0,o.s)(Y[0],c[0]-2,c[1]+2,0),(0,o.s)(Y[1],c[0]+2,c[1]+2,0),(0,o.s)(Y[2],c[0]+2,c[1]-2,0),(0,o.s)(Y[3],c[0]-2,c[1]-2,0);for(let e=0;e<4;e++)if(!h.unprojectFromRenderScreen(Y[e],K[e]))return;(0,d.zk)(h.eye,K[0],K[1],X),(0,d.zk)(h.eye,K[1],K[2],Q),(0,d.zk)(h.eye,K[2],K[3],ee),(0,d.zk)(h.eye,K[3],K[0],te);let u=Number.MAX_VALUE;for(let e=0;e<n.length-5;e+=3){if(N[0]=n[e]+r[12],N[1]=n[e+1]+r[13],N[2]=n[e+2]+r[14],j[0]=n[e+3]+r[12],j[1]=n[e+4]+r[13],j[2]=n[e+5]+r[14],(0,d.jH)(X,N)<0&&(0,d.jH)(X,j)<0||(0,d.jH)(Q,N)<0&&(0,d.jH)(Q,j)<0||(0,d.jH)(ee,N)<0&&(0,d.jH)(ee,j)<0||(0,d.jH)(te,N)<0&&(0,d.jH)(te,j)<0)continue;if(h.projectToRenderScreen(N,G),h.projectToRenderScreen(j,B),G[2]<0&&B[2]>0){(0,o.f)(U,N,j);const e=h.frustum,t=-(0,d.jH)(e[4],N)/(0,o.d)(U,(0,d.mJ)(e[4]));(0,o.a)(U,U,t),(0,o.b)(N,N,U),h.projectToRenderScreen(N,G)}else if(G[2]>0&&B[2]<0){(0,o.f)(U,j,N);const e=h.frustum,t=-(0,d.jH)(e[4],j)/(0,o.d)(U,(0,d.mJ)(e[4]));(0,o.a)(U,U,t),(0,o.b)(j,j,U),h.projectToRenderScreen(j,B)}else if(G[2]<0&&B[2]<0)continue;G[2]=0,B[2]=0;const t=(0,l.Jk)((0,l.zk)(G,B,q),c);t<u&&(u=t,(0,o.g)(k,N),(0,o.g)(Z,j))}const p=i.rayBeginPoint,f=i.rayEndPoint;if(u<4){let e=Number.MAX_VALUE;if((0,l.AR)((0,l.zk)(k,Z,q),(0,l.zk)(p,f,$),W)){(0,o.f)(W,W,p);const t=(0,o.l)(W);(0,o.a)(W,W,1/t),e=t/(0,o.i)(p,f)}s(e,W)}}computeAttachmentOrigin(e,t){const r=e.vertexAttributes;if(!r)return!1;const i=r.get("position");return(0,u.qZ)(i,null,!1,t)}createBufferWriter(){const e=this.params.vertexColors?v.IM:v.wp;return(0,s.Wi)(this.params.stipplePattern)?new v.G_(e):new F(e.clone().vec3f("auxpos1"))}getGLMaterial(e){return 0===e.output||4===e.output?new z(e):void 0}}class z extends p.Z{constructor(e){super(e),this.updateParameters()}updateParameters(){this._technique=this._techniqueRep.releaseAndAcquire(I,this._material.getTechniqueConfig(this._output),this._technique)}beginSlot(e){return 3===e}_updateOccludeeState(e){e.hasOccludees!==this._material.params.sceneHasOcludees&&(this._material.setParameterValues({sceneHasOcludees:e.hasOccludees}),this.updateParameters())}ensureParameters(e){0===this._output&&this._updateOccludeeState(e)}bind(e){this._technique.bindPass(this._material.getPassParameters(),e)}getPipelineState(e,t){return this._technique.getPipelineState(t)}}class F{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get("position").length}write(e,t,r,i){(0,m.NK)(t,this.vertexBufferLayout,e.transformation,e.invTranspTransformation,r,i),this.writeAuxpos1(e,t,r,i)}writeAuxpos1(e,t,r,i){const s=r.getField("auxpos1",c.ct),n=t.indices.get("position"),a=t.vertexAttributes.get("position").data,o=e.transformation,h=s.typedBufferStride,l=s.typedBuffer;i*=h;for(let e=0;e<n.length;e+=2){const t=3*n[e],r=a[t],s=a[t+1],d=a[t+2],c=o[0]*r+o[4]*s+o[8]*d+o[12],u=o[1]*r+o[5]*s+o[9]*d+o[13],p=o[2]*r+o[6]*s+o[10]*d+o[14];for(let e=0;e<2;++e)l[i]=c,l[i+1]=u,l[i+2]=p,i+=h}}}const V={color:[1,1,1,1],vertexColors:!1,slicePlaneEnabled:!1,width:1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,sceneHasOcludees:!1,...f.zh},N=(0,h.c)(),j=(0,h.c)(),U=(0,h.c)(),W=(0,h.c)(),G=(0,n.J$)(),B=(0,n.J$)(),k=(0,h.c)(),Z=(0,h.c)(),q=(0,l.Ue)(),$=(0,l.Ue)(),J=(0,h.c)(),Y=[(0,n.J$)(),(0,n.J$)(),(0,n.J$)(),(0,n.J$)()],K=[(0,h.c)(),(0,h.c)(),(0,h.c)(),(0,h.c)()],X=(0,d.Ue)(),Q=(0,d.Ue)(),ee=(0,d.Ue)(),te=(0,d.Ue)()},9816:(e,t,r)=>{r.d(t,{w:()=>n});var i=r(26701),s=r(16467);class n extends i.Z{constructor(e){super(e),this.updateParameters()}updateParameters(e){this._technique=this._techniqueRep.releaseAndAcquire(s.T,this._material.getTechniqueConfig(this._output,e),this._technique)}beginSlot(e){if(2===this._output)return 22===e;if(5===this._output)return null==e;if(4===this._output)return 3===e;let t=3;return this._material.params.transparent&&(t=this._material.params.writeDepth?5:8),e===t}setElapsedTimeUniform(e){const t=.001*this._material.animation.time;e.setUniform1f("timeElapsed",t*this._material.params.animationSpeed)}_updateShadowState(e){e.shadowMappingEnabled!==this._material.params.receiveShadows&&this._material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}_updateSSRState(e){e.ssrEnabled!==this._material.params.ssrEnabled&&this._material.setParameterValues({ssrEnabled:e.ssrEnabled})}ensureResources(e){return this._technique.ensureResource(e)}ensureParameters(e){0===this._output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}bind(e){this._technique.bindPass(this._material.params,e),2!==this._output&&0!==this._output||this.setElapsedTimeUniform(this._technique.program)}}},16467:(e,t,r)=>{r.d(t,{T:()=>y,k:()=>x});var i=r(56140),s=r(61514),n=r(72023),a=r(88214),o=r(71613),h=r(75619),l=r(91123),d=r(89553),c=r(23240),u=r(97853),p=r(44801),f=r(11379),g=r(66704),m=r(97111),v=r(74332),_=r(36904);class y extends u.A{constructor(e,t,r){super(e,t,r),this._textureRepository=e.waterTextureRepository}initializeProgram(e){const t=y.shader.get(),r=this.configuration,i=t.build({OITEnabled:0===r.transparencyPassType,output:r.output,viewingMode:e.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new m.$(e.rctx,i,f.i)}ensureResource(e){return this._textureRepository.ready||this._textureRepository.updating||this._textureRepository.loadTextures(e),this._textureRepository.ready?2:1}bindPass(e,t){(0,d.II)(this.program,t.camera.projectionMatrix),t.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",t.camera.nearFar),this.program.setUniform2fv("inverseViewport",t.inverseViewport),(0,a.p)(this.program,t)),0===this.configuration.output&&(t.lighting.setUniforms(this.program,!1),(0,h.O)(this.program,t)),0!==this.configuration.output&&2!==this.configuration.output||((0,l.b)(this.program,e),this._textureRepository.bind(this.program)),this.program.setUniform4fv("waterColor",e.color),4===this.configuration.output&&(0,n.wW)(this.program,t)}bindDraw(e){(0,d.id)(this.program,e),this.program.rebindTextures(),0!==this.configuration.output&&7!==this.configuration.output||(0,d.fb)(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&(0,o.O2)(this.program,e),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||(0,s.DA)(this.program,this.configuration,e)}setPipelineState(e){const t=this.configuration,r=3===e,i=2===e;return(0,_.sm)({blending:2!==t.output&&4!==t.output&&t.transparent?r?g.wu:(0,g.$L)(e):null,depthTest:{func:(0,g.$x)(e)},depthWrite:r?t.writeDepth&&_.LZ:(0,g.Vc)(e),colorWrite:_.BK,polygonOffset:r||i?null:(0,g.je)(t.enableOffset)})}initializePipeline(){return this.setPipelineState(this.configuration.transparencyPassType)}}y.shader=new c.J(v.W,(()=>r.e(6815).then(r.bind(r,16815))));class x extends p.m{constructor(){super(...arguments),this.output=0,this.receiveShadows=!1,this.slicePlaneEnabled=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.useSSR=!1,this.isDraped=!1,this.transparencyPassType=3,this.multipassTerrainEnabled=!1,this.cullAboveGround=!1}}(0,i._)([(0,p.o)({count:8})],x.prototype,"output",void 0),(0,i._)([(0,p.o)()],x.prototype,"receiveShadows",void 0),(0,i._)([(0,p.o)()],x.prototype,"slicePlaneEnabled",void 0),(0,i._)([(0,p.o)()],x.prototype,"transparent",void 0),(0,i._)([(0,p.o)()],x.prototype,"enableOffset",void 0),(0,i._)([(0,p.o)()],x.prototype,"writeDepth",void 0),(0,i._)([(0,p.o)()],x.prototype,"useSSR",void 0),(0,i._)([(0,p.o)()],x.prototype,"isDraped",void 0),(0,i._)([(0,p.o)({count:4})],x.prototype,"transparencyPassType",void 0),(0,i._)([(0,p.o)()],x.prototype,"multipassTerrainEnabled",void 0),(0,i._)([(0,p.o)()],x.prototype,"cullAboveGround",void 0)},48430:(e,t,r)=>{r.d(t,{i:()=>s});var i=r(59472);function s(e){return(0,i.Wi)(e)?e:e.slice()}}}]);